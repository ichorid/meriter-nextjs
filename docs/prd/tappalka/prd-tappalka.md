# PRD: Tappalka (Сравнение постов)

## Цель
Реализовать механику "Тапалка" — основной способ эмиссии меритов и заработка для пользователей через сравнение постов.

## Контекст
- Текущее состояние: Tappalka частично реализована (базовая механика), настройки и UI не завершены
- Проблема: Пользователям нужен способ зарабатывать мериты и участвовать в ранжировании контента
- Связанные модули: Posts, Merits/Wallet, Communities, Users, Community Settings

## Требования

### Функциональные
- [ ] FR-1: Пользователь может открыть экран Tappalka из сообщества с включённой механикой
- [ ] FR-2: Система показывает пару случайных постов для сравнения (свои посты исключены)
- [ ] FR-3: Пользователь выбирает лучший пост через drag-and-drop иконки мерита
- [ ] FR-4: Выбранный пост получает мериты (количество из настроек сообщества, default: 1)
- [ ] FR-5: За N сравнений пользователь получает M меритов на кошелёк (N и M из настроек)
- [ ] FR-6: Отображается прогресс (X/N) и текущий баланс меритов
- [ ] FR-7: При первом открытии показывается онбординг с текстом из настроек сообщества
- [ ] FR-8: Обработка случая "нет постов для сравнения"
- [ ] FR-9: В настройках сообщества добавляется блок Tappalka Settings:
  - Включена/выключена (`tappalkaEnabled`)
  - Категории постов для показа (`tappalkaCategories`)
  - Награда посту за победу (`tappalkaWinReward`, default: 1)
  - Награда пользователю (`tappalkaUserReward`, default: 1)
  - Количество сравнений для награды (`tappalkaComparisonsRequired`, default: 10)
  - Текст онбординга (`tappalkaOnboardingText`)

### Технические
- [ ] TR-1: tRPC router `tappalka` с endpoints: `getPair`, `submitChoice`, `getProgress`
- [ ] TR-2: `TappalkaService` для бизнес-логики выбора постов и начисления меритов
- [ ] TR-3: Zod-схемы в `shared-types` для типизации API и настроек
- [ ] TR-4: Расширить модель Community полями настроек Tappalka
- [ ] TR-5: React-компоненты с drag-and-drop механикой
- [ ] TR-6: Хуки TanStack Query для data fetching
- [ ] TR-7: UI для настроек Tappalka в админке сообщества

## Детали реализации

### Backend

**Новые сервисы:**
- `TappalkaService` — основная логика: выбор пар, обработка голосов, начисление наград

**Затронутые сервисы:**
- `MeritService` — эмиссия меритов победителю и пользователю
- `PostService` — выборка постов по условиям
- `CommunityService` — новые поля настроек

**Новые роутеры:**
- `tappalka.router.ts` — endpoints для игрового процесса

**Изменения в схемах БД:**
- `Community` — добавить поля tappalka-настроек
- `User` или отдельная коллекция — счётчик сравнений пользователя по сообществам

### Frontend

**Новые компоненты:**
- `TappalkaScreen` — основной контейнер экрана
- `TappalkaHeader` — прогресс (X/N), баланс, кнопка назад
- `TappalkaPostCard` — карточка поста (изображение, заголовок, описание)
- `TappalkaMeritIcon` — draggable иконка мерита
- `TappalkaOnboarding` — bottom sheet с текстом из настроек
- `TappalkaEmptyState` — состояние "нет постов"
- `TappalkaSettings` — блок настроек в админке сообщества

**Новые хуки:**
- `useTappalkaPair` — загрузка пары постов
- `useTappalkaChoice` — отправка выбора (mutation)
- `useTappalkaProgress` — прогресс и баланс пользователя

## Ограничения
- [ ] Не ломать: существующую систему постов, меритов, настроек сообществ
- [ ] MVP scope: включена только для МД и Проекты
- [ ] Fee за показ (0.1 с каждого поста) — использовать существующую логику из бизнес-документации
- [ ] Совместимость: с текущей системой permissions и ролей

## Acceptance Criteria
- [ ] AC-1: Пользователь может пройти N сравнений и получить M меритов (N, M из настроек)
- [ ] AC-2: Посты корректно фильтруются: свои исключены, rating >= tappalkaMinRating, только выбранные категории
- [ ] AC-3: Fee 0.1 списывается с обоих постов при каждом показе
- [ ] AC-4: Победитель получает tappalkaWinReward меритов (эмиссия)
- [ ] AC-5: Онбординг показывается только при первом открытии, текст берётся из настроек
- [ ] AC-6: При отсутствии постов — информативное сообщение
- [ ] AC-7: Лид/админ может настроить все параметры Tappalka в настройках сообщества
- [ ] AC-8: Изменение настроек сразу влияет на работу Tappalka

## Связанные файлы
Ключевые файлы для контекста (AI будет смотреть на них):
- `business-tappalka.mdc` — полная бизнес-логика механики
- `business-communities.mdc` — структура настроек сообществ
- `api/apps/meriter/src/services/` — примеры сервисов
- `api/apps/meriter/src/trpc/routers/` — примеры tRPC роутеров
- `web/src/features/` — примеры feature-структуры на фронте
- `libs/shared-types/src/` — Zod схемы

## Заметки
- Drag-and-drop: рассмотреть `@dnd-kit/core` (рекомендуется) или native HTML5 DnD
- Онбординг: сохранять флаг просмотра в user preferences на сервере
- Edge case: закрытие приложения посреди сравнения — при следующем открытии показать новую пару
- Edge case: пост удалён/закрыт между показом и выбором — валидировать на сервере, показать новую пару
- Категории: если не выбрана ни одна — показывать все посты сообщества
