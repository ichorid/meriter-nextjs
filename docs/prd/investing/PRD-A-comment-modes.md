# PRD: Режимы комментариев (Comment Modes)

## Цель
Добавить настройку режима комментариев на уровне сообщества: три режима (все типы / только нейтральные / только взвешенные). Перенести существующую настройку `tappalkaOnlyMode` в новый раздел "Комментарии".

## Контекст
- Текущее состояние: В UI есть тогл "Режим только Тапалка" в разделе "Настройки инвестиций", но он не работает. Нейтральные комментарии (weight=0) описаны в бизнес-документации, но UI не позволяет их создавать — сейчас голос обязан иметь вес.
- Проблема: Нет гибкости в настройке поведения комментариев. Для инвест-сообществ нужен режим без взвешенных комментариев (рейтинг формируется только тапалкой). Для других может потребоваться запрет нейтральных.
- Связанные модули: Настройки сообщества, диалог голосования/комментирования, бэкенд валидация комментариев.

## Требования

### Функциональные
- [ ] FR-1: Новый раздел "Комментарии" в настройках сообщества с полем `commentMode`
- [ ] FR-2: Три режима: `all` (взвешенные + нейтральные), `neutralOnly` (только нейтральные), `weightedOnly` (только взвешенные)
- [ ] FR-3: Дефолтное значение — `all`
- [ ] FR-4: В режиме `neutralOnly` — диалог голосования не показывает выбор веса, только текстовое поле. Кнопка "Голосовать" меняется на "Комментировать"
- [ ] FR-5: В режиме `weightedOnly` — поле веса обязательно, минимум 1 мерит (+ или -). Нулевой вес заблокирован
- [ ] FR-6: В режиме `all` — поведение как задокументировано: можно оставить 0, +N или -N
- [ ] FR-7: Удалить старый тогл `tappalkaOnlyMode` из раздела "Настройки инвестиций" (или перенести логику)
- [ ] FR-8: Бэкенд валидация: отклонять комментарии, не соответствующие режиму сообщества

### Технические
- [ ] TR-1: Добавить поле `commentMode` в схему сообщества (`enum: 'all' | 'neutralOnly' | 'weightedOnly'`, default: `'all'`)
- [ ] TR-2: Миграция: если `tappalkaOnlyMode = true`, конвертировать в `commentMode = 'neutralOnly'`
- [ ] TR-3: Обновить API создания комментария — валидация по `commentMode`
- [ ] TR-4: Обновить фронтенд диалога голосования — адаптация UI по режиму
- [ ] TR-5: Добавить секцию "Комментарии" в UI настроек сообщества

## Детали реализации

### Backend
- Изменяемые сервисы: CommentService (валидация), CommunitySettingsService
- Изменяемые роутеры: comment.create (добавить проверку commentMode), community.updateSettings
- Изменения в схемах БД: Community — добавить `commentMode: string`, убрать/deprecate `tappalkaOnlyMode`

### Frontend
- Изменяемые компоненты: VoteDialog (адаптация под режим), CommunitySettings (новая секция)
- Изменяемые хуки: useVote / useComment (учёт режима), useCommunitySettings
- Новые компоненты: CommentSettingsSection

## Ограничения
- [ ] Не ломать: существующие комментарии и голоса (данные не меняются, только валидация новых)
- [ ] Совместимость: плавная миграция с tappalkaOnlyMode
- [ ] Обратная совместимость: если `commentMode` не задан, поведение = `all`

## Acceptance Criteria
- [ ] AC-1: Админ может выбрать один из трёх режимов в настройках сообщества → раздел "Комментарии"
- [ ] AC-2: В режиме `neutralOnly` — пользователь видит только текстовое поле, без выбора веса. Попытка отправить вес через API → ошибка
- [ ] AC-3: В режиме `weightedOnly` — пользователь не может отправить комментарий с весом 0. Попытка через API → ошибка
- [ ] AC-4: В режиме `all` — доступны все три типа (позитивный, негативный, нейтральный)
- [ ] AC-5: Старый тогл tappalkaOnlyMode больше не отображается в UI инвестиций
- [ ] AC-6: Существующие сообщества с `tappalkaOnlyMode=true` корректно мигрировались в `commentMode=neutralOnly`

## Связанные файлы
- `business-content.mdc` — описание типов комментариев и правил голосования
- `business-investing.mdc` — упоминание tappalkaOnlyMode
- `05-comments.md` — бизнес-документация комментариев
- `02-communities.md` — настройки сообществ

## Таски

### Task A-1: Backend — схема и миграция
**Описание:** Добавить поле `commentMode` в модель Community. Написать миграцию для конвертации `tappalkaOnlyMode`.
**Scope:** Схема БД, миграция
**AC:** Поле существует, дефолт `all`, старые данные мигрированы

### Task A-2: Backend — валидация комментариев
**Описание:** В CommentService добавить проверку `commentMode` сообщества при создании комментария. Если режим `neutralOnly` и weight ≠ 0 → ошибка. Если режим `weightedOnly` и weight = 0 → ошибка.
**Scope:** CommentService, comment router
**AC:** API корректно отклоняет невалидные комментарии с понятным сообщением об ошибке

### Task A-3: Backend — API настроек
**Описание:** Добавить `commentMode` в endpoint обновления настроек сообщества. Убрать/deprecate `tappalkaOnlyMode`.
**Scope:** CommunitySettingsService, community router
**AC:** Админ может менять commentMode через API

### Task A-4: Frontend — секция "Комментарии" в настройках
**Описание:** Создать новую секцию в настройках сообщества с radio-группой из трёх режимов. Удалить тогл tappalkaOnlyMode из раздела инвестиций.
**Scope:** CommunitySettings page/component
**AC:** UI показывает три варианта, сохраняет выбор, старый тогл убран

### Task A-5: Frontend — адаптация диалога голосования
**Описание:** Диалог голосования должен подстраиваться под `commentMode` сообщества:
- `all`: текущее поведение + возможность оставить вес 0
- `neutralOnly`: убрать выбор веса, показать только текстовое поле, переименовать "Голосовать" → "Комментировать"
- `weightedOnly`: поле веса обязательно, валидация min=1
**Scope:** VoteDialog component, связанные хуки
**AC:** Диалог корректно адаптируется под все три режима

## Заметки
- Эта фича — самая изолированная, хороший кандидат на "first blood"
- Режим `neutralOnly` рекомендуется для сообществ с включёнными инвестициями
- В будущем возможно расширение: отдельные настройки для downvote (запрет даунвотов при разрешённых апвотах)
