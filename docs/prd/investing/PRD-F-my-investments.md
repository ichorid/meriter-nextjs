# PRD: "Мои инвестиции" в профиле

## Цель
Добавить экран "Мои инвестиции" в профиль пользователя: портфель всех инвестиций, статусы, доходность (SROI), итоговая статистика.

## Контекст
- Текущее состояние: В профиле нет информации об инвестициях пользователя. Инвестор не может увидеть общую картину своих вложений.
- Проблема: Инвестор не понимает, сколько он вложил суммарно, какой у него возврат, какие посты активны/закрыты.
- Связанные модули: Профиль пользователя, Investment records, Post data.
- Зависимости: Фича C (инвестиции), Фича D (закрытие постов, итоговые earnings).

## Требования

### Функциональные

**Экран "Мои инвестиции":**
- [ ] FR-1: Доступен из профиля пользователя (новая вкладка/секция)
- [ ] FR-2: Показывает только собственные инвестиции (приватный экран)

**Общая статистика (хедер экрана):**
- [ ] FR-3: Итого инвестировано (сумма всех вложений за всё время)
- [ ] FR-4: Итого получено (сумма всех выплат: доли от выводов + возвраты при закрытии)
- [ ] FR-5: SROI (Social Return on Investment): (получено - инвестировано) / инвестировано × 100%
- [ ] FR-6: Активные инвестиции (количество постов со статусом active)
- [ ] FR-7: Завершённые инвестиции (количество постов со статусом closed)

**Список инвестиций:**
- [ ] FR-8: Карточка инвестиции содержит: название поста (ссылка), автор, дата инвестиции, сумма вложенная, текущая доля (%), получено к текущему моменту, статус поста (active/closed)
- [ ] FR-9: Для active постов: текущий рейтинг, текущий пул, TTL (если есть), последний вывод автора
- [ ] FR-10: Для closed постов: финальные цифры (итого получено = возврат пула + доля от рейтинга)
- [ ] FR-11: Сортировка: по дате (новые первые), по сумме, по доходности
- [ ] FR-12: Фильтр: все / активные / завершённые

**Детали инвестиции (при клике на карточку):**
- [ ] FR-13: Полная история: все транзакции (вложения, полученные выплаты, возвраты)
- [ ] FR-14: Настройки поста (контракт, TTL, стоп-лосс) — read-only
- [ ] FR-15: Ссылка на пост

### Технические
- [ ] TR-1: API: `user.getMyInvestments()` — список всех инвестиций текущего пользователя с агрегированной статистикой
- [ ] TR-2: API: `user.getInvestmentDetails(postId)` — детали инвестиции в конкретный пост
- [ ] TR-3: Необходим трекинг earnings: при каждом выводе автора — записывать сколько получил каждый инвестор (для истории)
- [ ] TR-4: Поле в Investment record: `totalEarnings` (number, аккумулируемый) — сколько инвестор суммарно получил с этого поста

## Детали реализации

### Backend
- Новые сервисы: InvestorPortfolioService (aggregation queries)
- Изменяемые: InvestmentService (добавить трекинг earnings per investor)
- Новые роутеры: user.myInvestments, user.investmentDetails
- Изменения в схемах: Investment record — `+totalEarnings` (number, default 0), `+earningsHistory` (массив `{ amount, date, reason: 'withdrawal' | 'pool_return' | 'close' }`)

### Frontend
- Новые компоненты: MyInvestmentsPage, InvestmentStatsHeader, InvestmentCard, InvestmentDetailView, InvestmentHistoryList
- Изменяемые: ProfilePage (новая вкладка/навигация)

## Ограничения
- [ ] Только собственные инвестиции (приватность)
- [ ] Пагинация для пользователей с большим количеством инвестиций
- [ ] Агрегация должна быть эффективной (индексы по investorId)

## Acceptance Criteria
- [ ] AC-1: Пользователь с инвестициями видит экран "Мои инвестиции" в профиле
- [ ] AC-2: Общая статистика (итого вложено, получено, SROI) корректна
- [ ] AC-3: Список инвестиций показывает все посты с вложениями — active и closed
- [ ] AC-4: Сортировка и фильтрация работают
- [ ] AC-5: При клике на инвестицию — полная история транзакций
- [ ] AC-6: Для closed поста — финальные earnings видны
- [ ] AC-7: Пользователь без инвестиций видит empty state с пояснением

## Связанные файлы
- `business-investing.mdc` — раздел "Future Features: Investor Dashboard"
- Профиль пользователя (компоненты)

## Таски

### Task F-1: Backend — трекинг earnings per investor
**Описание:** При каждом распределении (вывод автора, возврат пула, закрытие) — обновлять `totalEarnings` и добавлять запись в `earningsHistory` для каждого инвестора. Это нужно добавить в InvestmentService и PostClosingService.
**Scope:** InvestmentService, PostClosingService, Investment schema
**AC:** После каждого распределения — totalEarnings обновлён, история записана

### Task F-2: Backend — API портфеля инвестиций
**Описание:** Endpoint `user.myInvestments`:
- Список всех постов где юзер = инвестор
- Для каждого: post summary (title, author, status), investment amount, share %, totalEarnings, last activity
- Агрегация: totalInvested, totalEarned, SROI
- Параметры: sort (date, amount, earnings), filter (all, active, closed), pagination
**Scope:** InvestorPortfolioService, user router
**AC:** API возвращает корректные данные с пагинацией

### Task F-3: Backend — API деталей инвестиции
**Описание:** Endpoint `user.investmentDetails(postId)`:
- Полная история earnings: массив транзакций (дата, сумма, причина)
- Настройки поста (контракт, TTL, стоп-лосс)
- Текущее состояние (rating, pool) для active, summary для closed
**Scope:** InvestorPortfolioService, user router
**AC:** API возвращает полную историю и настройки

### Task F-4: Frontend — экран "Мои инвестиции"
**Описание:** Страница в профиле: хедер со статистикой (итого вложено/получено/SROI/active/closed), список карточек инвестиций, сортировка, фильтр. Empty state.
**Scope:** MyInvestmentsPage, InvestmentStatsHeader, InvestmentCard
**AC:** Экран отображается, данные корректны, фильтры работают

### Task F-5: Frontend — детали инвестиции
**Описание:** Экран/модал деталей: полная история транзакций (timeline), настройки поста, ссылка на пост.
**Scope:** InvestmentDetailView, InvestmentHistoryList
**AC:** Полная история видна, навигация на пост работает

### Task F-6: Frontend — интеграция в профиль
**Описание:** Добавить вкладку/ссылку "Мои инвестиции" в навигацию профиля. Показывать вкладку только если у пользователя есть хотя бы одна инвестиция (или всегда, с empty state).
**Scope:** ProfilePage, навигация
**AC:** Вкладка доступна, переход работает

## Заметки
- Это последняя фича в цепочке — требует полностью работающих инвестиций (C) и закрытия (D)
- SROI — ключевая метрика для "геймификации" инвестирования
- В будущем: публичный рейтинг инвесторов (track record), автоматическое реинвестирование
- Для MVP — можно начать с упрощённого вида (без earningsHistory, только totalEarnings), и добавить timeline позже
