# Сводка бизнес-решений: Инвестиции и смежные фичи

> Дата: 13 февраля 2026
> Контекст: Масштабный рефакторинг UI/UX и бизнес-логики постов, инвестиций, комментариев

---

## Принятые решения

### 1. Архитектура счетов поста

**Решение: 2 счёта**

| Счёт | Назначение | Источники пополнения |
|------|-----------|---------------------|
| `rating` | Основной кошелёк поста | Тапалка (выигрыши), голоса (взвешенные комменты), авторские вложения |
| `investmentPool` | Инвесторский пул | Только инвестиции других пользователей |

- Авторские вложения идут в `rating`, НЕ являются инвестицией
- Автор НЕ получает долю при распределении инвесторам
- Сумма авторских вложений отображается как аналитическая метрика (из лога транзакций), а не как отдельный счёт

### 2. Порядок списания на показы в тапалке

```
investmentPool → rating → author.wallet (если флаг разрешает)
```

Если все источники исчерпаны — пост выходит из тапалки.

### 3. Управление затратами на тапалку

Два механизма (задаются автором при создании поста):

- **Стоп-лосс** — минимальный рейтинг, ниже которого пост не показывается в тапалке. Дефолт: 0 (выключен). Mutable (можно менять после создания).
- **Флаг "не тратить из кошелька автора"** — если `true`, при исчерпании investmentPool + rating пост выходит из тапалки, не трогая author.wallet. Mutable.

### 4. Режимы комментариев (настройка сообщества)

Три режима:

| Режим | Взвешенные (+/-) | Нейтральные (0) | Когда использовать |
|-------|:-:|:-:|---|
| `all` | ✅ | ✅ | По умолчанию, стандартное поведение |
| `neutralOnly` | ❌ | ✅ | Рекомендуется для инвест-сообществ (бывший tappalkaOnlyMode) |
| `weightedOnly` | ✅ | ❌ | Специальные сообщества, где комментарий обязан нести вес |

Настройка переезжает в новый раздел **"Комментарии"** в настройках сообщества.

### 5. Статусы поста

Два статуса: **Active** и **Closed**.

**Active** — всё работает: тапалка, инвестиции, комментарии, вывод меритов.

**Closed** — пост заморожен:
- Остаётся видимым в ленте и профиле
- Рейтинг не меняется
- Только нейтральные комментарии (fee берётся, мериты сгорают)
- Инвестиции заблокированы
- Все мериты распределены, на посте 0
- Показывается историческая сводка вместо рейтинга
- Закрытие **необратимо** (в будущем — "переоткрыть пост" за мериты)

### 6. Триггеры закрытия

| Триггер | Описание | Настраивается |
|---------|---------|:---:|
| Ручное | Автор нажимает "Закрыть пост" | — |
| По TTL | Срок жизни поста истёк | Автор при создании |
| По исчерпанию | Все ресурсы = 0 и пост не зарабатывал 7 дней | В настройках сообщества |
| По отриц. рейтингу | Рейтинг < 0 → 24ч → списание с кошелька → Closed | Существующая механика |

### 7. Процедура закрытия поста (с инвестициями)

```
1. Пост переходит в статус Closed
2. Пост выходит из тапалки
3. Неизрасходованный investmentPool → возврат инвесторам (пропорционально вкладам)
4. Весь оставшийся rating → распределение по контракту (X% инвесторам, остальное автору)
5. На посте остаётся 0 меритов
6. Показывается историческая сводка
7. Нотификации всем инвесторам с итоговыми цифрами
```

### 8. Настройки поста при создании

| Настройка | Обязательность | Immutable? | Дефолт |
|-----------|:---:|:---:|---|
| Инвестиции вкл/выкл | При создании | Да | Выкл |
| Процент инвесторам | Если инвестиции вкл | Да | — |
| TTL (срок жизни) | Определяется сообществом | Да (или только увеличивать) | Бессрочно |
| Стоп-лосс | Нет | Нет | 0 (выключен) |
| Флаг "не тратить из кошелька" | Нет | Нет | false |

Фиксированные варианты TTL: 7 / 14 / 30 / 60 / 90 дней / бессрочно.
Обязательность TTL для постов с инвестициями — настраивается в сообществе.

### 9. Информация, видимая инвесторам

Перед инвестированием:
- Контракт (% инвесторам)
- TTL (когда закроется)
- Стоп-лосс
- Флаг "автор платит из кошелька" — да/нет
- Текущее состояние investmentPool и rating
- Количество инвесторов
- Визуальная шкала долей инвесторов

После инвестирования (и в любой момент):
- Всё вышеперечисленное
- Твоя текущая доля и сумма вложений
- История выводов автора (сколько раз, сколько снимал)
- Расчёт: "если автор выведет X, ты получишь Y"

### 10. Настройки сообщества (новые/изменённые)

**Новый раздел "Комментарии":**
- `commentMode`: `all` | `neutralOnly` | `weightedOnly`

**Раздел "Инвестиции" (существующий, расширить):**
- `investingEnabled`: boolean
- `investorShareMin` / `investorShareMax`: 1-99%
- `requireTTLForInvestPosts`: boolean (обязательный TTL)
- `maxTTL`: number (макс. срок жизни поста, дней)
- `inactiveCloseDays`: number (дней без заработка до автозакрытия, дефолт 7)

---

## Порядок реализации

| # | Фича | Зависит от | Сложность |
|---|------|-----------|-----------|
| A | Режимы комментариев | — | Низкая |
| B | Настройки поста при создании | — | Средняя |
| C | Инвестиции v1 | B | Высокая |
| D | Закрытие постов | B, C | Высокая |
| E | UI-рефакторинг карточки поста | C, D | Средняя |
| F | "Мои инвестиции" в профиле | C, D | Средняя |
