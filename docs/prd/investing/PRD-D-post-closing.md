# PRD: Закрытие постов

## Цель
Реализовать механику закрытия постов: ручное закрытие автором, автоматическое по TTL и по исчерпанию ресурсов. При закрытии — распределение всех меритов, заморозка поста с показом исторической сводки.

## Контекст
- Текущее состояние: Закрытие постов описано в документации, но не реализовано на платформе. Посты висят вечно. Для инвестиций это критическая проблема — инвесторы не получат возврат неизрасходованного пула.
- Проблема: Нет способа завершить жизненный цикл поста. Инвесторы застревают навечно. Автор не может "закрыть проект". Нет автоматического закрытия неактивных постов.
- Связанные модули: Post lifecycle, Investments (распределение при закрытии), Tappalka (выход), Notifications, Post card UI.
- Зависимости: Фича B (TTL в настройках поста), Фича C (investmentPool, распределение).

## Требования

### Функциональные

**Ручное закрытие:**
- [ ] FR-1: Кнопка "Закрыть пост" доступна автору (в меню действий поста)
- [ ] FR-2: Диалог подтверждения: "Закрытие необратимо. Все мериты будут распределены. Пост останется видимым, но заморозится."
- [ ] FR-3: Для постов с инвестициями — показать preview распределения: сколько из пула вернётся инвесторам, сколько из rating распределится по контракту
- [ ] FR-4: После подтверждения — выполнить процедуру закрытия (см. ниже)

**Автоматическое закрытие по TTL:**
- [ ] FR-5: Cron job / scheduled task: проверять посты с `ttlExpiresAt < now()` и `status = active`
- [ ] FR-6: При срабатывании — автоматическая процедура закрытия
- [ ] FR-7: Нотификация автору: "Ваш пост [название] закрыт по истечении срока жизни (TTL)"
- [ ] FR-8: За 24 часа до TTL — предупредительная нотификация автору

**Автоматическое закрытие по исчерпанию:**
- [ ] FR-9: Триггер: investmentPool=0 AND rating≤0 AND (author.wallet=0 OR noAuthorWalletSpend=true) AND пост не зарабатывал `inactiveCloseDays` дней
- [ ] FR-10: "Не зарабатывал" = не получал позитивных комментариев и не выигрывал в тапалке
- [ ] FR-11: Нотификация автору с предупреждением за 24ч: "Ваш пост будет закрыт через 24 часа из-за отсутствия активности"

**Процедура закрытия (общая для всех триггеров):**
- [ ] FR-12: Пост выходит из тапалки
- [ ] FR-13: Блокируются: новые инвестиции, взвешенные комменты, вывод меритов, добавление меритов автором
- [ ] FR-14: Возврат неизрасходованного investmentPool инвесторам (пропорционально вкладам) → на wallet каждого
- [ ] FR-15: Весь оставшийся rating распределяется по контракту: X% инвесторам (пропорционально), остальное автору → на wallets
- [ ] FR-16: На посте остаётся 0 меритов (investmentPool=0, rating=0)
- [ ] FR-17: Статус поста → `closed`
- [ ] FR-18: Нотификации всем инвесторам: "Пост закрыт. Возврат из пула: A меритов. Ваша доля от рейтинга: B меритов. Итого получено: C меритов"

**Закрытый пост (состояние closed):**
- [ ] FR-19: Виден в ленте и профиле с пометкой "Закрыт" (badge/label)
- [ ] FR-20: Принимает только нейтральные комментарии (fee берётся как обычно)
- [ ] FR-21: Все финансовые кнопки скрыты/заблокированы (инвестировать, добавить мериты, забрать мериты, голосовать с весом)
- [ ] FR-22: Вместо блока рейтинга — историческая сводка: "Итого заработано: X. Распределено инвесторам: Y. Получено автором: Z. Потрачено на показы: W."
- [ ] FR-23: Блок инвестиций показывает финальный результат: список инвесторов с итоговыми earnings

**Закрытие поста БЕЗ инвестиций:**
- [ ] FR-24: Упрощённая процедура: весь rating → автору на wallet. Нет распределения. Статус closed.

### Технические
- [ ] TR-1: Поле `status` в модели Post (enum: `active` | `closed`, default `active`)
- [ ] TR-2: Поле `closedAt` (Date, nullable)
- [ ] TR-3: Поле `closeReason` (enum: `manual` | `ttl` | `inactive` | `negative_rating`)
- [ ] TR-4: Поля для исторической сводки: `closingSummary` (JSON: totalEarned, distributedToInvestors, authorReceived, spentOnShows)
- [ ] TR-5: Cron job для TTL-закрытия (проверка каждый час)
- [ ] TR-6: Cron job / trigger для закрытия по неактивности
- [ ] TR-7: Поле `lastEarnedAt` в Post (Date) — трекинг последнего заработка для триггера неактивности
- [ ] TR-8: API: `post.close(postId)` — ручное закрытие
- [ ] TR-9: Все API с мутациями поста — проверка `status !== closed`

## Детали реализации

### Backend
- Новые сервисы: PostClosingService (процедура закрытия, распределение)
- Изменяемые сервисы: PostService (статус, валидация), InvestmentService (возврат пула, финальное распределение), TappalkaService (выход), NotificationService
- Новые: Cron jobs (TTL checker, inactivity checker)
- Изменяемые роутеры: post.close (новый), все существующие мутации — guard по status
- Изменения в схемах БД: Post — `+status`, `+closedAt`, `+closeReason`, `+closingSummary`, `+lastEarnedAt`

### Frontend
- Новые компоненты: ClosePostDialog (с preview распределения), ClosedPostBadge, ClosingSummaryBlock
- Изменяемые компоненты: PostCard (показ badge, сводка вместо рейтинга, блокировка кнопок), PostActions (добавить "Закрыть пост"), VoteDialog (блокировка взвешенных на closed)
- Изменяемые хуки: usePost (учёт status), useVote (блокировка)

## Ограничения
- [ ] Не ломать: существующие активные посты (status=active по умолчанию)
- [ ] Не ломать: посты без инвестиций — упрощённое закрытие
- [ ] Закрытие необратимо (в MVP)
- [ ] Процедура распределения должна быть атомарной (транзакция)
- [ ] Cron jobs должны быть идемпотентными (повторный запуск не должен повторно распределять)

## Acceptance Criteria
- [ ] AC-1: Автор может закрыть пост вручную → мериты распределены, статус closed
- [ ] AC-2: Пост с TTL=30 дней закрывается автоматически через 30 дней
- [ ] AC-3: Нотификация за 24ч до TTL-закрытия
- [ ] AC-4: Пост без ресурсов + 7 дней без заработка → автоматическое закрытие
- [ ] AC-5: При закрытии поста с инвестициями: неизрасходованный пул возвращён + rating распределён по контракту
- [ ] AC-6: Инвесторы получают нотификации с итоговыми цифрами
- [ ] AC-7: Закрытый пост виден в ленте с badge "Закрыт"
- [ ] AC-8: На закрытом посте можно оставить только нейтральный комментарий
- [ ] AC-9: Попытка инвестировать в закрытый пост → ошибка
- [ ] AC-10: Историческая сводка отображается корректно
- [ ] AC-11: Закрытие поста без инвестиций — автор получает все мериты из rating

## Связанные файлы
- `business-investing.mdc` — раздел "Post Closing with Investments"
- `business-content.mdc` — Post Lifecycle, Negative Rating
- `04-posts.md` — жизненный цикл постов

## Таски

### Task D-1: Backend — схема Post (статус и закрытие)
**Описание:** Добавить в Post: `status` (enum `active`/`closed`, default `active`), `closedAt` (Date, nullable), `closeReason` (enum, nullable), `closingSummary` (JSON, nullable), `lastEarnedAt` (Date, nullable). Миграция: все существующие посты → `status=active`.
**Scope:** Post model/schema
**AC:** Поля существуют, миграция прошла

### Task D-2: Backend — PostClosingService
**Описание:** Сервис с методом `closePost(postId, reason)`:
1. Проверить status=active
2. Удалить из тапалки
3. Если есть investmentPool > 0 → возврат инвесторам (пропорционально)
4. Если есть rating > 0 и есть инвесторы → распределить по контракту
5. Если есть rating > 0 и нет инвесторов → всё автору
6. Обнулить investmentPool и rating
7. Записать closingSummary
8. Установить status=closed, closedAt=now, closeReason
9. Отправить нотификации
Весь процесс — в транзакции.
**Scope:** PostClosingService (новый)
**AC:** Атомарное закрытие, корректное распределение

### Task D-3: Backend — API ручного закрытия
**Описание:** Endpoint `post.close(postId)`:
- Только автор может закрыть
- Вызывает PostClosingService.closePost(postId, 'manual')
- Возвращает closingSummary
**Scope:** post router
**AC:** Автор может закрыть, другие — нет

### Task D-4: Backend — guards для closed постов
**Описание:** Добавить проверку `post.status !== 'closed'` во все мутации: invest, addMerits, withdrawMerits, vote (взвешенный). Нейтральные комменты — разрешены.
**Scope:** Все post-related роутеры и сервисы
**AC:** Любая финансовая мутация на closed посте → ошибка. Нейтральный коммент → ОК.

### Task D-5: Backend — Cron: TTL закрытие
**Описание:** Scheduled job (каждый час): найти посты с `status=active AND ttlExpiresAt < now()`. Для каждого → `PostClosingService.closePost(id, 'ttl')`. Идемпотентность: проверять status перед закрытием.
**Scope:** Cron/scheduler
**AC:** Посты с истёкшим TTL закрываются автоматически

### Task D-6: Backend — Cron: предупреждение за 24ч до TTL
**Описание:** Scheduled job: найти посты с `ttlExpiresAt - now() < 24h AND ttlExpiresAt > now() AND status=active AND не отправляли уже предупреждение`. Нотификация автору.
**Scope:** Cron/scheduler, NotificationService
**AC:** Автор получает предупреждение ровно один раз

### Task D-7: Backend — Cron: закрытие по неактивности
**Описание:** Scheduled job (раз в день): найти посты с `status=active AND investmentPool=0 AND rating<=0 AND (noAuthorWalletSpend=true OR author.wallet=0) AND lastEarnedAt < now() - inactiveCloseDays`. Закрыть каждый. За 24ч — предупреждение.
**Scope:** Cron/scheduler
**AC:** Неактивные посты закрываются, предупреждение отправляется

### Task D-8: Backend — трекинг lastEarnedAt
**Описание:** Обновлять `lastEarnedAt` при: получении позитивного комментария, выигрыше в тапалке.
**Scope:** CommentService, TappalkaService
**AC:** Поле обновляется при каждом заработке

### Task D-9: Frontend — кнопка "Закрыть пост" и диалог
**Описание:** Добавить "Закрыть пост" в меню действий (для автора). Диалог подтверждения с preview распределения (для инвест-постов). Для обычных постов — простое подтверждение.
**Scope:** PostActions, ClosePostDialog
**AC:** Автор может закрыть с подтверждением, preview корректен

### Task D-10: Frontend — отображение закрытого поста
**Описание:**
- Badge "Закрыт" на карточке (с причиной: "По сроку", "Вручную", "Неактивен")
- Сводка вместо блока рейтинга: заработано, распределено, потрачено
- Скрытие финансовых кнопок
- Комментарии: только нейтральные (адаптировать VoteDialog для closed постов)
- Блок инвестиций: финальные результаты
**Scope:** PostCard, PostPage, ClosedPostBadge, ClosingSummaryBlock
**AC:** Закрытый пост отображается корректно со всей исторической информацией

## Заметки
- Атомарность процедуры закрытия критична — если упадёт посередине, не должно быть частичного распределения
- lastEarnedAt нужно заполнить для существующих постов при миграции (можно поставить createdAt как дефолт)
- Предупреждение за 24ч — нужен флаг `ttlWarningNotified` чтобы не слать повторно
- В будущем: "переоткрыть пост" — потребует отдельной фичи
