# Мастер-список тасков: Инвестиции и смежные фичи

> Порядок реализации: A → B → C → D → E → F
> Общее количество тасков: 39

---

## Фича A: Режимы комментариев (5 тасков)

| # | Таск | Тип | Описание |
|---|------|-----|----------|
| A-1 | Схема и миграция | Backend | `commentMode` в Community, миграция tappalkaOnlyMode |
| A-2 | Валидация комментариев | Backend | Проверка commentMode при создании комментария |
| A-3 | API настроек | Backend | commentMode в endpoint настроек сообщества |
| A-4 | Секция "Комментарии" | Frontend | Новая секция в настройках сообщества |
| A-5 | Адаптация диалога голосования | Frontend | VoteDialog подстраивается под режим |

**Ожидаемая сложность:** Низкая (2-3 дня)

---

## Фича B: Настройки поста при создании (7 тасков)

| # | Таск | Тип | Описание |
|---|------|-----|----------|
| B-1 | Схема Post (новые поля) | Backend | investingEnabled, ttlDays, stopLoss, noAuthorWalletSpend |
| B-2 | Схема Community (новые поля) | Backend | requireTTLForInvestPosts, maxTTL, inactiveCloseDays |
| B-3 | Валидация при создании поста | Backend | Проверка всех расширенных настроек |
| B-4 | Обновление mutable настроек | Backend | stopLoss, noAuthorWalletSpend mutable; TTL только увеличивать |
| B-5 | Секция "Расширенные настройки" | Frontend | Раскрываемая секция в форме создания поста |
| B-6 | Настройки сообщества (инвестиции) | Frontend | requireTTL, maxTTL, inactiveCloseDays в настройках |
| B-7 | Редактирование mutable настроек | Frontend | UI для изменения стоп-лосса и флага кошелька |

**Ожидаемая сложность:** Средняя (3-5 дней)

---

## Фича C: Инвестиции v1 (10 тасков)

| # | Таск | Тип | Описание |
|---|------|-----|----------|
| C-1 | Модель данных инвестиций | Backend | investmentPool, investments[] в Post |
| C-2 | InvestmentService.invest() | Backend | Процесс вложения: проверки, списание, upsert |
| C-3 | InvestmentService.getBreakdown() | Backend | Брейкдаун по инвесторам |
| C-4 | Вывод с распределением | Backend | Обновить withdrawal: split по контракту |
| C-5 | TappalkaService — порядок списания | Backend | investmentPool → rating → author.wallet |
| C-6 | Диалог инвестирования | Frontend | Расширенный диалог со всей информацией |
| C-7 | Блок инвестиций на карточке | Frontend | Иконка + пул + инвесторы на PostCard + PostPage |
| C-8 | Попап брейкдауна инвесторов | Frontend | Список инвесторов, доли, визуальная шкала |
| C-9 | Расширенный диалог вывода | Frontend | Preview распределения при выводе |
| C-10 | Нотификации | Backend + Frontend | Новая инвестиция, вывод, исчерпание пула |

**Ожидаемая сложность:** Высокая (7-10 дней)

---

## Фича D: Закрытие постов (10 тасков)

| # | Таск | Тип | Описание |
|---|------|-----|----------|
| D-1 | Схема Post (статус, закрытие) | Backend | status, closedAt, closeReason, closingSummary, lastEarnedAt |
| D-2 | PostClosingService | Backend | Процедура закрытия: распределение, обнуление, нотификации |
| D-3 | API ручного закрытия | Backend | post.close endpoint |
| D-4 | Guards для closed постов | Backend | Блокировка мутаций на закрытых постах |
| D-5 | Cron: TTL закрытие | Backend | Автозакрытие по истёкшему TTL |
| D-6 | Cron: предупреждение за 24ч | Backend | Нотификация перед TTL-закрытием |
| D-7 | Cron: закрытие по неактивности | Backend | Автозакрытие исчерпанных + неактивных |
| D-8 | Трекинг lastEarnedAt | Backend | Обновление при каждом заработке |
| D-9 | Кнопка "Закрыть пост" + диалог | Frontend | UI закрытия с preview распределения |
| D-10 | Отображение закрытого поста | Frontend | Badge, сводка, блокировка кнопок |

**Ожидаемая сложность:** Высокая (7-10 дней)

---

## Фича E: UI-рефакторинг карточки поста (6 тасков)

| # | Таск | Тип | Описание |
|---|------|-----|----------|
| E-1 | Декомпозиция PostCard | Frontend | Разбить на PostHeader + PostContent + PostMetrics + PostActions |
| E-2 | PostMetrics — блок метрик | Frontend | Рейтинг, инвестиции, TTL, closed сводка |
| E-3 | PostActions — контекстные действия | Frontend | Кнопки по роли и статусу |
| E-4 | Синхронизация PostPage | Frontend | Переиспользование компонентов + расширенные блоки |
| E-5 | Перенос admin-кнопок в меню | Frontend | +/- в three-dot menu |
| E-6 | Мобильная адаптация | Frontend | Responsive для 320-768px |

**Ожидаемая сложность:** Средняя (4-6 дней)

---

## Фича F: "Мои инвестиции" в профиле (6 тасков)

| # | Таск | Тип | Описание |
|---|------|-----|----------|
| F-1 | Трекинг earnings per investor | Backend | totalEarnings + earningsHistory при каждом распределении |
| F-2 | API портфеля инвестиций | Backend | user.myInvestments с агрегацией и пагинацией |
| F-3 | API деталей инвестиции | Backend | user.investmentDetails с историей |
| F-4 | Экран "Мои инвестиции" | Frontend | Страница в профиле: статистика + список |
| F-5 | Детали инвестиции | Frontend | Timeline транзакций, настройки поста |
| F-6 | Интеграция в профиль | Frontend | Вкладка в навигации профиля |

**Ожидаемая сложность:** Средняя (4-6 дней)

---

## Суммарная оценка

| Фича | Backend тасков | Frontend тасков | Дни (оценка) |
|------|:-:|:-:|:-:|
| A — Комментарии | 3 | 2 | 2-3 |
| B — Настройки поста | 4 | 3 | 3-5 |
| C — Инвестиции | 6 | 4 | 7-10 |
| D — Закрытие | 8 | 2 | 7-10 |
| E — UI рефакторинг | 0 | 6 | 4-6 |
| F — Портфель | 3 | 3 | 4-6 |
| **Итого** | **24** | **20** | **27-40** |

---

## Критический путь

```
A (комментарии) ──────────────────────────────────► можно кидать в Cursor сразу
      │
B (настройки поста) ──────────────────────────────► после A или параллельно
      │
      ├──► C (инвестиции) ────────────────────────► зависит от B
      │         │
      │         ├──► D (закрытие) ────────────────► зависит от B + C
      │         │         │
      │         │         ├──► F (портфель) ──────► зависит от C + D
      │         │         │
      │         └─────────┴──► E (UI рефакторинг) ► можно параллелить с D, финализировать после
```
