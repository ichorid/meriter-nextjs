# PRD: Инвестиции v1

## Цель
Реализовать полный цикл инвестирования меритов в посты: вложение, учёт долей, распределение при выводе, UI инвестиций на карточке поста (кнопка, диалог, брейкдаун, повторная инвестиция).

## Контекст
- Текущее состояние: В UI есть кнопка "Инвестировать" и базовый диалог (скрин 6), но функционал неполный — мало информации в диалоге, нет брейкдауна по инвесторам, нет расчёта доли при повторной инвестиции, нет UI-контролов инвестиций на странице поста (только в ленте).
- Проблема: CEO хочет "социальные инвестиции" как ключевую фичу. Текущий UI не даёт инвестору достаточно информации для принятия решения и не обеспечивает прозрачность.
- Связанные модули: Post (investmentPool, rating), Merit withdrawal, Tappalka show cost deduction, Post card UI.
- Зависимости: Фича B (настройки поста при создании) — контракт и investingEnabled.

## Требования

### Функциональные

**Процесс инвестирования:**
- [ ] FR-1: Кнопка "Инвестировать" видна на посте только если `post.investingEnabled=true` и текущий пользователь ≠ автор
- [ ] FR-2: Автор вместо "Инвестировать" видит "Добавить мериты" (вложение в rating, не инвестиция)
- [ ] FR-3: Диалог инвестирования показывает: контракт (%), текущий investmentPool, количество инвесторов, TTL (если задан), стоп-лосс, флаг кошелька автора, визуальную шкалу долей инвесторов
- [ ] FR-4: При вводе суммы — динамический расчёт: "Ваша доля составит X% от каждого вывода (инвесторам)"
- [ ] FR-5: При повторной инвестиции — показать: "Вы уже инвестировали N меритов. После этого вложения ваш итого: M меритов, доля: X%"
- [ ] FR-6: Предупреждение: "Инвестиция безвозвратна. Мериты тратятся на показы в тапалке. Возврат возможен только при закрытии поста (неизрасходованный остаток) и при выводе автором (ваша доля)."
- [ ] FR-7: Инвестировать можно только из wallet (не из квоты)
- [ ] FR-8: Одна запись на инвестора на пост — повторные инвестиции аккумулируются

**Отображение на карточке поста:**
- [ ] FR-9: Блок инвестиций на карточке: иконка + сумма investmentPool + количество инвесторов
- [ ] FR-10: Клик по блоку инвестиций → попап с брейкдауном: список инвесторов (имя кликабельно → профиль), сумма, доля (%), дата первой/последней инвестиции
- [ ] FR-11: Визуальная сегментированная шкала (bar) — показывает доли инвесторов пропорционально
- [ ] FR-12: Одинаковый функционал инвестиций в ленте и на странице поста

**Вывод меритов с распределением:**
- [ ] FR-13: При выводе автором — показывать расчёт: "Вы выводите X меритов. Инвесторам (Y%): Z меритов. Вам: W меритов. Подробнее: [раскрываемый список инвесторов с суммами]"
- [ ] FR-14: После подтверждения — мериты распределяются: author gets (100-Y)%, investors get Y% пропорционально долям
- [ ] FR-15: Нотификация каждому инвестору: "Автор вывел X меритов. Ваша доля: M меритов"
- [ ] FR-16: Кнопка "Забрать мериты" — автор может снять частичную или полную сумму из rating

**Списание на тапалку (обновление):**
- [ ] FR-17: Порядок списания: investmentPool → rating → author.wallet (если noAuthorWalletSpend=false)
- [ ] FR-18: Если noAuthorWalletSpend=true и investmentPool + rating = 0 → пост выходит из тапалки
- [ ] FR-19: Нотификация автору: "Инвестиционный пул исчерпан, показы теперь из рейтинга/кошелька" (или "пост вышел из тапалки")

### Технические
- [ ] TR-1: Поле `investmentPool` в модели Post (number, default 0)
- [ ] TR-2: Поле `investmentPoolTotal` в модели Post (число — сколько всего инвестировано за всё время, для аналитики)
- [ ] TR-3: Коллекция/массив `investments` в Post: `{ investorId, amount, createdAt, updatedAt }`
- [ ] TR-4: API: `post.invest(postId, amount)` — вложить мериты
- [ ] TR-5: API: `post.getInvestmentBreakdown(postId)` — получить брейкдаун инвесторов
- [ ] TR-6: Обновить `post.withdrawMerits` — добавить распределение по контракту
- [ ] TR-7: Обновить TappalkaService — использовать новый порядок списания с учётом `noAuthorWalletSpend`
- [ ] TR-8: NotificationService — нотификации по инвест-событиям

## Детали реализации

### Backend
- Новые сервисы: InvestmentService (invest, getBreakdown, distributeOnWithdraw)
- Изменяемые сервисы: MeritWithdrawalService (распределение), TappalkaService (порядок списания)
- Новые/изменяемые роутеры: post.invest, post.investmentBreakdown, post.withdrawMerits (расширить)
- Изменения в схемах БД: Post — `+investmentPool`, `+investmentPoolTotal`, `+investments[]`

### Frontend
- Новые компоненты: InvestDialog (расширенный), InvestmentBreakdownPopup, InvestorBar (визуальная шкала), WithdrawDialog (расширенный с расчётом распределения)
- Изменяемые компоненты: PostCard (блок инвестиций), PostPage (добавить инвест-контролы)
- Новые хуки: useInvest, useInvestmentBreakdown
- Изменяемые хуки: useWithdrawMerits (расчёт распределения)

## Ограничения
- [ ] Не ломать: существующие мериты и рейтинги постов
- [ ] Не ломать: текущий вывод меритов для постов без инвестиций (поведение без изменений)
- [ ] Инвестировать можно только из wallet, не из квоты
- [ ] Инвестиция безвозвратна (до закрытия поста)
- [ ] Контракт immutable — процент фиксирован при создании

## Acceptance Criteria
- [ ] AC-1: Пользователь может инвестировать в чужой пост с `investingEnabled=true` → мериты списываются из wallet в investmentPool
- [ ] AC-2: Повторная инвестиция аккумулируется в существующую запись
- [ ] AC-3: Диалог инвестирования показывает всю необходимую информацию (контракт, пул, инвесторы, TTL, расчёт доли)
- [ ] AC-4: Клик по блоку инвестиций → попап с полным брейкдауном (инвесторы, суммы, доли)
- [ ] AC-5: Автор выводит 100 меритов с контрактом 20% → автор получает 80, инвесторы получают 20 (пропорционально долям)
- [ ] AC-6: Каждый инвестор получает нотификацию при выводе с указанием своей доли
- [ ] AC-7: Тапалка списывает в правильном порядке: investmentPool → rating → author.wallet
- [ ] AC-8: При `noAuthorWalletSpend=true` пост выходит из тапалки при исчерпании investmentPool + rating
- [ ] AC-9: Инвест-контролы одинаково работают в ленте и на странице поста
- [ ] AC-10: Автор видит "Добавить мериты" вместо "Инвестировать" — его мериты идут в rating

## Связанные файлы
- `business-investing.mdc` — полная бизнес-логика инвестиций (ОСНОВНОЙ ИСТОЧНИК ПРАВДЫ)
- `business-content.mdc` — посты, рейтинг, вывод меритов
- `business-tappalka.mdc` — механика тапалки, стоимость показов

## Таски

### Task C-1: Backend — модель данных инвестиций
**Описание:** Добавить в Post: `investmentPool` (number, 0), `investmentPoolTotal` (number, 0), `investments` (массив `{ investorId: ObjectId, amount: number, createdAt: Date, updatedAt: Date }`). Индекс по `investments.investorId` для быстрого поиска.
**Scope:** Post model/schema
**AC:** Поля существуют, индекс создан

### Task C-2: Backend — InvestmentService.invest()
**Описание:** Метод для вложения меритов:
1. Проверить что пост существует, `investingEnabled=true`, статус Active
2. Проверить что юзер ≠ автор
3. Проверить баланс wallet (не квота)
4. Списать мериты из wallet
5. Добавить в investmentPool
6. Обновить investmentPoolTotal
7. Upsert запись в investments (если есть — amount += new, updatedAt = now; если нет — создать)
8. Нотификация автору
**Scope:** InvestmentService, post router
**AC:** Мериты корректно переводятся, запись создаётся/обновляется

### Task C-3: Backend — InvestmentService.getBreakdown()
**Описание:** Метод для получения брейкдауна: список инвесторов с суммами, долями, датами. Включить общую статистику: totalPool, totalInvested, investorCount.
**Scope:** InvestmentService, post router
**AC:** API возвращает полный брейкдаун с вычисленными долями

### Task C-4: Backend — обновить вывод меритов (распределение)
**Описание:** В MeritWithdrawalService при выводе из поста с инвестициями:
1. Рассчитать investorShare = amount × investorSharePercent%
2. Распределить investorShare пропорционально долям инвесторов
3. Зачислить каждому инвестору на wallet
4. Зачислить автору (amount - investorShare)
5. Уменьшить rating поста на amount
6. Нотификации инвесторам
**Scope:** MeritWithdrawalService, NotificationService
**AC:** Корректное распределение по контракту, нотификации отправлены

### Task C-5: Backend — обновить TappalkaService (порядок списания)
**Описание:** При списании 0.1 мерита за показ:
1. Списать из investmentPool (если > 0)
2. Если investmentPool = 0 → списать из rating
3. Если rating ≤ stopLoss → проверить noAuthorWalletSpend
4. Если noAuthorWalletSpend=false → списать из author.wallet
5. Если noAuthorWalletSpend=true или author.wallet=0 → пост выходит из тапалки
6. Нотификация при исчерпании investmentPool
**Scope:** TappalkaService
**AC:** Порядок списания соблюдается, пост корректно выходит из тапалки

### Task C-6: Frontend — диалог инвестирования (расширенный)
**Описание:** Переделать диалог инвестирования:
- Показать: контракт %, текущий пул, кол-во инвесторов, TTL, стоп-лосс, флаг кошелька
- Input суммы с динамическим расчётом доли
- При повторной инвестиции: показать предыдущую сумму и итоговую долю
- Предупреждение о безвозвратности
- Визуальная шкала инвесторов
**Scope:** InvestDialog component
**AC:** Диалог показывает всю информацию, расчёт работает динамически

### Task C-7: Frontend — блок инвестиций на карточке поста
**Описание:** Добавить на карточку поста (и в ленте, и на странице): блок с иконкой инвестиций, суммой investmentPool, числом инвесторов. Клик → попап с брейкдауном.
**Scope:** PostCard, PostPage
**AC:** Блок виден, попап открывается, данные корректны

### Task C-8: Frontend — попап брейкдауна инвесторов
**Описание:** Попап со списком инвесторов: имя (ссылка на профиль), сумма, доля %, дата. Визуальная сегментированная шкала (bar). Общая статистика.
**Scope:** InvestmentBreakdownPopup, InvestorBar
**AC:** Все инвесторы отображаются, доли корректны, имена кликабельны

### Task C-9: Frontend — расширенный диалог вывода меритов
**Описание:** При выводе автором — показать расчёт распределения:
- "Вы выводите: [input]"
- "Инвесторам (X%): Y меритов"
- "Вам: Z меритов"
- Раскрываемый список: кто из инвесторов сколько получит
**Scope:** WithdrawDialog
**AC:** Расчёт показывается до подтверждения, совпадает с реальным распределением

### Task C-10: Backend + Frontend — нотификации
**Описание:** Добавить нотификации: новая инвестиция (автору), вывод с распределением (инвесторам), исчерпание пула (автору).
**Scope:** NotificationService, NotificationTypes
**AC:** Нотификации приходят корректно с правильными цифрами

## Заметки
- Это самая объёмная фича. Можно параллелить backend (C-1..C-5) и frontend (C-6..C-9)
- `business-investing.mdc` — основной источник правды для бизнес-логики
- Визуальная шкала инвесторов (segmented bar) — приятный UX-элемент, но можно MVP без неё и добавить позже
- Edge case: что если при выводе дробные мериты не делятся ровно? Округлять до 0.01, остаток — автору
