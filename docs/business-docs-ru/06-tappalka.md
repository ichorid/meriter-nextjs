# 06. Тапалка

> Специальная механика сравнения постов для эмиссии меритов.

---

## Концепция

Тапалка — основной способ эмиссии меритов и заработка для пользователей.

**Суть механики:**
1. Пользователю показываются 2 случайных поста из сообщества
2. Он выбирает, какой ему больше нравится
3. Выбранный пост получает мерит (эмиссия)
4. За серию сравнений пользователь получает награду

---

## Механика работы

### Процесс сравнения

```
┌─────────────────────────────────────────────────────────┐
│           Пользователь открывает Тапалку                │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│    Система выбирает 2 случайных поста из сообщества     │
│    (свои посты пользователя НЕ показываются)            │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│         Пользователь выбирает один из двух              │
└───────┬───────────────────────────────┬─────────────────┘
        │                               │
        ▼                               ▼
┌───────────────────┐         ┌───────────────────────────┐
│  Выбранный пост   │         │   Невыбранный пост        │
│  +1 мерит         │         │   0 меритов               │
│  (эмиссия)        │         │   (но fee за показ        │
└───────────────────┘         │    всё равно списан)      │
                              └───────────────────────────┘
```

### Награда пользователю
- За **10 успешно проведённых сравнений** = **1 мерит** на кошелёк
- Мериты начисляются как эмиссия (не от других пользователей)

---

## Параметры тапалки

### Базовые параметры (настраиваются админом)

| Параметр | Значение по умолчанию | Описание |
|----------|----------------------|----------|
| `tappalkaShowCost` | 0.1 мерита | Стоимость одного показа поста |
| `tappalkaWinReward` | 1 мерит | Награда посту за выбор |
| `tappalkaMinRating` | 1 мерит | Минимальный рейтинг для участия |
| `tappalkaUserReward` | 1 мерит за 10 сравнений | Награда пользователю |

### Стоимость показа
- Каждый показ поста в тапалке стоит **0.1 мерита**
- Оплачивается с рейтинга поста ИЛИ кошелька автора
- Списывается с **обоих** постов в паре (и с победителя, и с проигравшего)

---

## Участие постов в тапалке

### Условия участия
1. Тапалка включена для сообщества
2. Рейтинг поста ≥ минимального порога (по умолчанию 1 мерит)
3. Рейтинг поста ≥ стоп-лосса, установленного автором
4. Пост не закрыт

### Выбытие из тапалки
Пост перестаёт показываться, если:
- Рейтинг упал ниже минимального порога
- Рейтинг упал ниже стоп-лосса автора
- Нет средств для оплаты показа (ни на посте, ни у автора)

### Стоп-лосс
- Устанавливается владельцем поста
- Минимальный порог рейтинга, ниже которого пост не показывается
- Защита от «сливания» меритов на показы проигрывающего поста

### Важно: нельзя отключить показ в тапалке
- Автор **не может** выбрать «не показывать в тапалке»
- Единственный способ убрать пост из тапалки:
  1. Установить высокий стоп-лосс
  2. Закрыть пост и снять все мериты

---

## Фильтрация в тапалке

### По категориям
Тапалка может фильтровать посты по категориям:
- Пользователь выбирает интересующие категории
- Показываются только посты из выбранных категорий

### По типу контента (планируется)
- Базовые посты сравниваются с базовыми
- Проекты с проектами (когда будут реализованы)
- Опросы в тапалке не участвуют

---

## Включение тапалки

### Для каких сообществ
- По умолчанию **выключена**
- В MVP: включена только для **«Марафон Добра»** и **«Проекты»**
- Для каждого сообщества настраивается отдельно

### Связь с квотой
**Решение:** Квота в глобальных сообществах **выключается** сразу после появления тапалки.

Логика: тапалка становится основным источником эмиссии, квота больше не нужна для обеспечения активности.

---

## Защита от злоупотреблений

### Свои посты не показываются
- Пользователь никогда не увидит свои посты в тапалке
- Исключает возможность «накрутки» своих постов

### Стоимость показа
- Оба поста платят за показ, даже проигравший
- Делает невыгодным создание «мусорных» постов для участия

### Минимальный рейтинг
- Новые посты без меритов не попадают в тапалку сразу
- Нужно сначала получить поддержку через комментарии

---

## Экономика тапалки

### Баланс эмиссии

**На одно сравнение:**
- Расход: 0.2 мерита (0.1 × 2 поста за показ)
- Приход: 1 мерит победителю
- Чистая эмиссия: 0.8 мерита

**На 10 сравнений:**
- Расход: 2 мерита (показы)
- Приход постам: 10 меритов (10 победителей)
- Приход пользователю: 1 мерит
- Чистая эмиссия: 9 меритов

### Контроль инфляции
- Fee за посты и комментарии сжигают мериты
- Негативные комментарии сжигают мериты
- Минусовые рейтинги списывают мериты с кошельков
