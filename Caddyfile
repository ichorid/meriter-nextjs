# Caddyfile for Meriter application
# Replace {$DOMAIN} with your actual domain or use environment variable

# Enable admin API for reloading without restart (only accessible from localhost)
{
	admin localhost:2019
}

# Support both HTTP and HTTPS for localhost development
{$DOMAIN} {
    # Enable access logs
    log {
        output stdout
        level INFO
    }

    # Security headers - applied globally
    header {
        # HSTS - Enforce HTTPS connections (1 year)
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"
        
        # Clickjacking protection
        X-Frame-Options "DENY"
        
        # XSS protection (legacy but still useful)
        X-XSS-Protection "1; mode=block"
        
        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # Permissions policy - restrict browser features
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        
        # Content Security Policy - adjust based on your app's needs
        # Allow self, Telegram API, and common CDNs
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://api.telegram.org https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://api.telegram.org; frame-src 'self' https://oauth.telegram.org;"
        
        # Remove server header for security
        -Server
    }

    # Rate limiting for API endpoints (stricter limits)
    # Note: Caddy v2 doesn't have built-in rate limiting - requires caddy-ratelimit plugin
    # To enable rate limiting, build Caddy with: xcaddy build --with github.com/mholt/caddy-ratelimit
    # For now, rate limiting is configured but will be ignored without the plugin
    # Alternative: Use Caddy's built-in request limiting via reverse_proxy timeouts
    handle /api* {
        # Rate limiting configuration (requires caddy-ratelimit plugin)
        # Uncomment and configure when plugin is installed:
        # rate_limit {
        #     zone api_zone {
        #         key {remote_host}
        #         events 100
        #         window 1m
        #     }
        # }
        
        # Add rate limit headers
        header {
            X-RateLimit-Limit "100"
            X-RateLimit-Window "60"
        }
        
        reverse_proxy api:8002 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
        encode gzip
    }

    # tRPC requests - proxy to backend API
    # Must come before static file handlers to ensure proper routing
    handle /trpc* {
        reverse_proxy api:8002 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
        encode gzip
    }

    # Serve static files from /var/www/meriter-web/current
    # The 'current' symlink inside web-static points to the active versioned directory
    root * /var/www/meriter-web/current
    
    # Next.js static assets - long cache
    handle /_next/static/* {
        file_server
        header Cache-Control "public, max-age=31536000, immutable"
    }
    
    # Source map files - serve if exists, otherwise return 204 No Content (prevents 404 errors in logs)
    # This prevents source map requests from being served as HTML or cluttering logs
    # Note: Source maps are enabled for dev builds (NEXT_PUBLIC_DEV_BUILD=true)
    # but some source maps (e.g., from React DevTools) may not exist
    @map_files {
        path_regexp ^.*\.map$
    }
    handle @map_files {
        file_server
        header Cache-Control "public, max-age=0, must-revalidate"
    }

    # ----------------------------------------------------------------------------
    # Dynamic route placeholders (Next.js static export)
    #
    # Next.js `output: 'export'` generates placeholder HTML files for dynamic routes
    # (e.g. `/meriter/communities/_.html`, `/meriter/users/_.html`).
    #
    # If we fall back to `/index.html` for these deep links, the app boots the wrong
    # route tree and can get stuck on the "BAILOUT_TO_CLIENT_SIDE_RENDERING" spinner.
    # These handlers ensure dynamic deep links serve the correct placeholder HTML.
    # ----------------------------------------------------------------------------

    @community_post_dynamic {
        path_regexp community_post_dynamic ^/meriter/communities/[^/]+/posts/[^/]+/?$
    }
    handle @community_post_dynamic {
        file_server
        try_files {path}.html /meriter/communities/_/posts/_.html /index.html
        header Cache-Control "public, max-age=3600"
    }

    @community_edit_dynamic {
        path_regexp community_edit_dynamic ^/meriter/communities/[^/]+/edit/[^/]+/?$
    }
    handle @community_edit_dynamic {
        file_server
        try_files {path}.html /meriter/communities/_/edit/_.html /index.html
        header Cache-Control "public, max-age=3600"
    }

    @community_edit_poll_dynamic {
        path_regexp community_edit_poll_dynamic ^/meriter/communities/[^/]+/edit-poll/[^/]+/?$
    }
    handle @community_edit_poll_dynamic {
        file_server
        try_files {path}.html /meriter/communities/_/edit-poll/_.html /index.html
        header Cache-Control "public, max-age=3600"
    }

    @community_subpage_dynamic {
        path_regexp community_subpage_dynamic ^/meriter/communities/[^/]+/(members|rules|settings|create|create-poll)/?$
    }
    handle @community_subpage_dynamic {
        file_server
        try_files {path}.html /meriter/communities/_/{re.community_subpage_dynamic.1}.html /index.html
        header Cache-Control "public, max-age=3600"
    }

    @community_dynamic {
        path_regexp community_dynamic ^/meriter/communities/[^/]+/?$
    }
    handle @community_dynamic {
        file_server
        try_files {path}.html /meriter/communities/_.html /index.html
        header Cache-Control "public, max-age=3600"
    }

    @user_dynamic {
        path_regexp user_dynamic ^/meriter/users/[^/]+/?$
    }
    handle @user_dynamic {
        file_server
        try_files {path}.html /meriter/users/_.html /index.html
        header Cache-Control "public, max-age=3600"
    }
    
    # Public assets
    # Try {path}.html first (Next.js generates .html files), then fallback to index.html
    handle /meriter/* {
        file_server
        try_files {path}.html {path} /index.html
        header Cache-Control "public, max-age=3600"
    }
    
    # SPA fallback - all other routes serve index.html
    # Try {path}.html first (Next.js generates .html files), then fallback to index.html
    handle {
        file_server
        try_files {path}.html {path} /index.html
        header Cache-Control "public, max-age=0, must-revalidate"
    }
    
    encode gzip
    
    # Error handling - return 204 for missing .map files to prevent 404 logs
    # This must be at the end of the server block
    handle_errors {
        @map_404 {
            expression {err.status_code} == 404
            path_regexp ^.*\.map$
        }
        handle @map_404 {
            respond 204
        }
    }
}

