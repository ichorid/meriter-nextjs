# Caddyfile for Meriter application
# Replace {$DOMAIN} with your actual domain or use environment variable

{$DOMAIN:localhost} {
    # Enable access logs
    log {
        output file /var/log/caddy/access.log
        format console
    }

    # Route /api/* directly to NestJS backend
    handle /api/* {
        reverse_proxy api:8002 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Everything else goes to Next.js web application
    handle {
        reverse_proxy web:8001 {
            # Health check
            health_uri /
            health_interval 30s
            health_timeout 10s
            
            # Headers
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Enable compression
    encode gzip

    # Error handling
    handle_errors {
        respond "{err.status_code} {err.status_text}"
    }
}

# Automatic HTTPS will be enabled when using a real domain
# For local development, HTTP will be used

