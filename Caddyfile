# Caddyfile for Meriter application
# Replace {$DOMAIN} with your actual domain or use environment variable

{
    # Global options
    auto_https disable_redirects
    email {$CADDY_EMAIL:admin@{$DOMAIN}}
}

{$DOMAIN:localhost} {
    # Enable access logs
    log {
        output file /var/log/caddy/access.log
        format console
        level INFO
    }

    # Specific API routes handled by NestJS backend
    handle /api/geticonslogojoy* {
        reverse_proxy meriter-api:8002
    }

    handle /api/d* {
        reverse_proxy meriter-api:8002
    }

    # All other API requests go to NestJS backend
    handle /api* {
        reverse_proxy meriter-api:8002
    }

    # Everything else goes to Next.js frontend
    handle {
        reverse_proxy meriter-web:8001
    }

    # Enable compression
    encode gzip

    # Error handling
    handle_errors {
        respond "{err.status_code} {err.status_text}"
    }
}

