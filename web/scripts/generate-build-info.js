/* eslint-disable no-console */
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

function readJson(filePath) {
  return JSON.parse(fs.readFileSync(filePath, 'utf-8'));
}

function safeExec(cmd, options) {
  try {
    return execSync(cmd, { stdio: ['ignore', 'pipe', 'ignore'], ...options })
      .toString()
      .trim();
  } catch {
    return null;
  }
}

function computeBuildSha() {
  const envSha =
    process.env.NEXT_PUBLIC_BUILD_SHA ||
    process.env.COMMIT_SHA ||
    process.env.GITHUB_SHA ||
    process.env.VERCEL_GIT_COMMIT_SHA ||
    process.env.CI_COMMIT_SHA ||
    null;

  if (envSha && typeof envSha === 'string') {
    return envSha.slice(0, 12);
  }

  // Repo root is one level up from /web
  const gitSha = safeExec('git -C .. rev-parse --short=12 HEAD', { cwd: __dirname });
  return gitSha;
}

function pickPackageVersions(pkg) {
  const deps = { ...(pkg.dependencies || {}), ...(pkg.devDependencies || {}) };

  const pick = (name) => (typeof deps[name] === 'string' ? deps[name] : 'unknown');

  return {
    app: typeof pkg.version === 'string' ? pkg.version : 'unknown',
    next: pick('next'),
    react: pick('react'),
    'react-dom': pick('react-dom'),
    '@tanstack/react-query': pick('@tanstack/react-query'),
    '@trpc/client': pick('@trpc/client'),
    axios: pick('axios'),
  };
}

function main() {
  const webRoot = path.join(__dirname, '..');
  const pkgPath = path.join(webRoot, 'package.json');
  const pkg = readJson(pkgPath);

  const sha = computeBuildSha() || 'unknown';
  const buildTimeIso = new Date().toISOString();
  const packageVersions = pickPackageVersions(pkg);

  const outDir = path.join(webRoot, 'src', 'generated');
  const outFile = path.join(outDir, 'build-info.ts');

  fs.mkdirSync(outDir, { recursive: true });

  const content =
    `// AUTO-GENERATED FILE. Do not edit directly.\n` +
    `// Generated by web/scripts/generate-build-info.js\n` +
    `\n` +
    `export const FRONTEND_BUILD_SHA = ${JSON.stringify(sha)} as const;\n` +
    `export const FRONTEND_BUILD_TIME_ISO = ${JSON.stringify(buildTimeIso)} as const;\n` +
    `export const FRONTEND_PACKAGE_VERSIONS = ${JSON.stringify(packageVersions, null, 2)} as const;\n`;

  fs.writeFileSync(outFile, content, 'utf-8');
  console.log(`[build-info] Wrote ${path.relative(webRoot, outFile)} (sha=${sha})`);
}

main();


