services:
  mongodb:
    image: mongo:8.0
    container_name: meriter-mongodb
    restart: unless-stopped
    # Security: MongoDB port not exposed to host in production
    # Access only through Docker network
    # ports:
    #   - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD_FILE=/run/secrets/mongo_admin_password
      - MONGO_INITDB_DATABASE=meriter
      # App password will be read from secret file in init script
      - MONGO_APP_PASSWORD_FILE=/run/secrets/mongo_app_password
    volumes:
      - mongodb_data:/data/db
      - ./mongodb-init:/docker-entrypoint-initdb.d:ro
    secrets:
      - mongo_admin_password
      - mongo_app_password
    networks:
      - meriter-database-network
    healthcheck:
      test: mongosh --quiet --eval "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
    security_opt:
      - no-new-privileges:true

  web:
    image: ghcr.io/ichorid/meriter-nextjs-web:${VERSION_WEB:-latest}
    container_name: meriter-web
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - PORT=8001
      - NODE_ENV=production
      # Pass DOMAIN as NEXT_PUBLIC_DOMAIN for client-side usage
      - NEXT_PUBLIC_DOMAIN=${DOMAIN}
      # BOT_USERNAME must be set - passed from .env file or explicitly here
      # If not set, container will fail health checks
    # Security: Web port not exposed to host, only accessible through Caddy
    # ports:
    #   - "8001:8001"
    networks:
      - meriter-frontend-network
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://127.0.0.1:8001 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp

  api:
    image: ghcr.io/ichorid/meriter-nextjs-api:${VERSION_API:-latest}
    container_name: meriter-api
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - PORT=8002
      - NODE_ENV=production
      # MongoDB connection with authentication
      - MONGO_URL=mongodb://meriter_user:${MONGO_APP_PASSWORD}@mongodb:27017/meriter?authSource=meriter
    # Security: API port not exposed to host, only accessible through Caddy
    # ports:
    #   - "8002:8002"
    networks:
      - meriter-backend-network
      - meriter-database-network
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://127.0.0.1:8002/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp

  bot-webhook-init:
    image: ghcr.io/ichorid/meriter-nextjs-api:${VERSION_API:-latest}
    container_name: meriter-bot-webhook-init
    restart: "no"
    env_file:
      - .env
    environment:
      - APP_URL=https://${DOMAIN}
      - BOT_USERNAME=${BOT_USERNAME}
      - BOT_TOKEN=${BOT_TOKEN}
    depends_on:
      api:
        condition: service_started
    command: ["node", "scripts/setup-webhook.js", "set"]
    networks:
      - meriter-backend-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
    security_opt:
      - no-new-privileges:true

  s3-cors-init:
    image: ghcr.io/ichorid/meriter-nextjs-api:${VERSION_API:-latest}
    container_name: meriter-s3-cors-init
    restart: "no"
    env_file:
      - .env
    environment:
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_REGION=${S3_REGION}
    depends_on:
      api:
        condition: service_started
    command: ["node", "scripts/configure-s3-cors.js", "${S3_BUCKET_NAME}", "${DOMAIN}"]
    networks:
      - meriter-backend-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
    security_opt:
      - no-new-privileges:true

  caddy:
    image: caddy:2.7-alpine
    container_name: meriter-caddy
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - meriter-frontend-network
      - meriter-backend-network
    depends_on:
      web:
        condition: service_healthy
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://127.0.0.1:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
    security_opt:
      - no-new-privileges:true
    # Caddy needs write access to /data and /config for certificates
    # read_only: true  # Cannot use read_only due to certificate storage

networks:
  # Frontend network: web and caddy
  meriter-frontend-network:
    driver: bridge
    internal: false
  # Backend network: api and init containers
  meriter-backend-network:
    driver: bridge
    internal: false
  # Database network: mongodb and api only
  meriter-database-network:
    driver: bridge
    internal: true  # Isolated from other networks

volumes:
  mongodb_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local

secrets:
  mongo_admin_password:
    file: ./secrets/mongo_admin_password.txt
  mongo_app_password:
    file: ./secrets/mongo_app_password.txt
