---
description: Code structure and architecture patterns. Include when adding new modules, services, or significant refactoring.
globs:
  - api/apps/meriter/src/**/*
  - web/src/**/*
  - libs/**/*
alwaysApply: false
---

# Meriter Architecture

## Monorepo Structure
```
meriter-nextjs/
â”œâ”€â”€ api/                          # Backend package (@meriter/api)
â”œâ”€â”€ web/                          # Frontend package (@meriter/web)
â”œâ”€â”€ libs/shared-types/            # Shared types package
â”œâ”€â”€ package.json                  # Root package (monorepo)
â””â”€â”€ pnpm-workspace.yaml           # pnpm workspace config
```

Note: `web/pnpm-workspace.yaml` also exists in this repository.

## Backend Structure (api/)
```
api/apps/meriter/src/
â”œâ”€â”€ domain/                       # ğŸ”µ Domain layer (business logic)
â”‚   â”œâ”€â”€ models/[entity]/          # Mongoose schemas and documents
â”‚   â”œâ”€â”€ services/                 # Business services and domain modules (publication, vote, wallet, quota reset, post-closing cron, tappalka, ...)
â”‚   â”‚   â””â”€â”€ factors/              # Factor-based decision helpers (currency/role/social constraints)
â”‚   â”œâ”€â”€ aggregates/               # Domain aggregates/entities
â”‚   â”œâ”€â”€ events/                   # Domain events + event bus
â”‚   â”œâ”€â”€ value-objects/            # Strongly-typed identifiers/value objects
â”‚   â””â”€â”€ common/helpers/           # Domain helpers/constants
â”œâ”€â”€ domain.module.ts              # Shared NestJS module wiring domain providers/models
â”œâ”€â”€ trpc/                         # ğŸŸ¢ tRPC layer (API)
â”‚   â””â”€â”€ routers/
â”‚       â””â”€â”€ [entity].router.ts    # tRPC procedures (aggregation in trpc/router.ts)
â”œâ”€â”€ api-v1/                       # ğŸŸ¡ REST layer (auth/uploads/config) + api-v1/common helpers/services/mappers/utils/interfaces
â”œâ”€â”€ common/                       # Shared backend utilities
â”‚   â””â”€â”€ schemas/                  # Backend-only Zod schemas (currently minimal)
â”œâ”€â”€ config/                       # Configuration
â”œâ”€â”€ telegram/                     # Telegram integration
â”œâ”€â”€ tg-bots/                      # Telegram bot module and services
â”œâ”€â”€ updates-conductors/           # Update conductor subsystem
â”œâ”€â”€ migrations/                   # One-off migration scripts
â”œâ”€â”€ meriter.module.ts             # Root Nest module composition
â”œâ”€â”€ meriter.controller.ts         # Root controller
â”œâ”€â”€ meriter.service.ts            # Root app service
â”œâ”€â”€ config.ts                     # Runtime config bootstrap
â”œâ”€â”€ permission.guard.ts           # Permission guard
â”œâ”€â”€ user.guard.ts                 # Authenticated user guard
â””â”€â”€ main.ts                       # App entry point
```

Notes:
- `domain/models/` includes auth-related schemas (e.g. passkey challenge schema)
- Domain contains dedicated background modules/services (e.g. quota reset and post-closing cron modules)

### Adding New Backend Feature
1. Add/update schema in `domain/models/[entity]/`; for cross-cutting models, a top-level schema file under `domain/models/` is also used in this codebase
2. Implement business logic in `domain/services/`
3. Register providers/models in `domain.module.ts` (shared domain wiring)
4. Expose use-case via tRPC router in `trpc/routers/[entity].router.ts` and aggregate in `trpc/router.ts`
5. If REST exposure is required, add controller/service under `api-v1/` and reuse `api-v1/common` helpers/services when applicable
6. Add/update shared contracts in `libs/shared-types/src/` when shape is cross-package

## Frontend Structure (web/)
```
web/src/
â”œâ”€â”€ app/                          # ğŸ”µ Next.js App Router
â”‚   â”œâ”€â”€ meriter/                  # Main app routes
â”‚   â”œâ”€â”€ tests/                    # Test/demo routes
â”‚   â”œâ”€â”€ **/route.ts               # App Router route handlers (server endpoints)
â”‚   â”œâ”€â”€ layout.tsx                # Root layout
â”‚   â””â”€â”€ page.tsx                  # Home page
â”œâ”€â”€ components/                   # ğŸŸ¢ UI Components
â”‚   â”œâ”€â”€ ui/                       # Base UI (buttons, inputs)
â”‚   â”œâ”€â”€ molecules/                # Composite UI pieces
â”‚   â”œâ”€â”€ organisms/                # Complex feature blocks
â”‚   â”œâ”€â”€ templates/                # Page/layout templates
â”‚   â”œâ”€â”€ settings/                 # Settings-related components
â”‚   â””â”€â”€ providers/                # React provider wrappers/components
â”œâ”€â”€ features/                     # ğŸŸ¡ Feature modules
â”œâ”€â”€ hooks/                        # Custom React hooks
â”œâ”€â”€ stores/                       # Zustand stores
â”œâ”€â”€ contexts/                     # React contexts
â”œâ”€â”€ lib/                          # Utilities & helpers (incl. tRPC client)
â”œâ”€â”€ i18n/                         # i18n request/config layer
â”œâ”€â”€ config/                       # Runtime frontend config
â”œâ”€â”€ providers/                    # Provider components
â”œâ”€â”€ shared/                       # Shared UI/lib/hooks/stores/types
â”œâ”€â”€ types/                        # TypeScript types
â”œâ”€â”€ generated/                    # Auto-generated build metadata
â””â”€â”€ __tests__/                    # Frontend tests
```

### Adding New Frontend Feature
1. Place UI in `components/`, `features/*/components`, or `shared/components` depending on scope
2. Create hooks in `hooks/` for app-level logic or `shared/hooks/` for reusable cross-feature logic
3. Create store in `stores/*.store.ts` or `shared/stores/*.store.ts` if needed
4. Add page in `app/[route]/page.tsx`

## Shared Types (libs/shared-types/)
```
libs/shared-types/src/
â”œâ”€â”€ base-schemas.ts               # Base Zod primitives
â”œâ”€â”€ schemas.ts                    # Complex DTOs
â”œâ”€â”€ taxonomy.ts                   # Shared taxonomy enums/lists
â”œâ”€â”€ tappalka.ts                   # Shared tappalka-specific schemas
â””â”€â”€ index.ts                      # Public exports
```

### When to Use Shared Types
âœ… Type is used in BOTH frontend and backend
âœ… Type is part of API contract
âŒ Type is backend-only validation â†’ use `api/apps/meriter/src/common/schemas/`
âŒ Type is frontend-only UI state â†’ use `web/src/types/`

## Key Patterns

### Service Layer (Backend)
```typescript
// domain/services/[entity].service.ts
@Injectable()
export class EntityService {
  constructor(
    @InjectModel(Entity.name) private model: Model<Entity>,
    private otherService: OtherService,
  ) {}

  async create(dto: CreateEntityDto): Promise<Entity> {
    // Business logic here
  }
}
```

### tRPC Router (Backend)
```typescript
// trpc/routers/[entity].router.ts
export const entityRouter = router({
  getById: protectedProcedure
    .input(z.object({ id: z.string() }))
    .query(async ({ ctx, input }) => {
      return ctx.entityService.getById(input.id);
    }),
});
```

### Component Pattern (Frontend)
```typescript
// components/[feature]/FeatureCard.tsx
interface FeatureCardProps {
  data: FeatureData;
  onAction?: () => void;
}

export function FeatureCard({ data, onAction }: FeatureCardProps) {
  // Component logic
}
```

## File Naming

| Type | Convention | Example |
|------|------------|---------|
| Components | Mixed (PascalCase and kebab-case) | `VoteButton.tsx`, `card-comment-vote.tsx` |
| Hooks | use-prefixed files in hooks/, including helper companions | `useVoting.ts`, `useVotes.helpers.ts` |
| Services | kebab-case + .service | `vote.service.ts` |
| Schemas | kebab-case + .schema | `vote.schema.ts` |
| Routers | kebab-case + .router | `vote.router.ts` |
| Stores | kebab-case + .store | `vote.store.ts` |

## Module Dependencies
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           libs/shared-types             â”‚ â† Shared contracts
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   api/      â”‚ â—„â”€â”€â”€â”€â”€â–º â”‚   web/      â”‚
â”‚  (Backend)  â”‚tRPC+RESTâ”‚ (Frontend)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Common Mistakes

âŒ Importing backend runtime code from `api/` in `web/`
âœ… Type-only import bridge from `api/apps/meriter/src/trpc/types` is used in this codebase
âŒ Duplicating types instead of using shared-types
âš ï¸ Prefer keeping new business logic in services; current codebase still contains substantial logic in some routers (legacy/transition areas)
âŒ Putting reusable shared components only in `app/` (prefer `components/`, `features/*/components`, or `shared/components`)
