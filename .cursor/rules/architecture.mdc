---
description: Code structure and architecture patterns. Include when adding new modules, services, or significant refactoring.
globs:
  - api/apps/meriter/src/**/*
  - web/src/**/*
  - libs/**/*
alwaysApply: false
---

# Meriter Architecture

## Monorepo Structure
```
meriter-nextjs/
â”œâ”€â”€ api/                          # Backend package (@meriter/api)
â”œâ”€â”€ web/                          # Frontend package (@meriter/web)
â”œâ”€â”€ libs/shared-types/            # Shared types package
â”œâ”€â”€ package.json                  # Root package (monorepo)
â””â”€â”€ pnpm-workspace.yaml           # pnpm workspace config
```

## Backend Structure (api/)
```
api/apps/meriter/src/
â”œâ”€â”€ domain/                       # ğŸ”µ Domain layer (business logic)
â”‚   â”œâ”€â”€ user/                     # User entity & services
â”‚   â”œâ”€â”€ community/                # Community entity & services
â”‚   â”œâ”€â”€ publication/              # Publication entity & services
â”‚   â”œâ”€â”€ vote/                     # Vote entity & services
â”‚   â”œâ”€â”€ permission/               # Permission services & rules
â”‚   â””â”€â”€ [entity]/
â”‚       â”œâ”€â”€ [entity].schema.ts    # Mongoose schema
â”‚       â”œâ”€â”€ [entity].service.ts   # Business logic
â”‚       â””â”€â”€ [entity].module.ts    # NestJS module
â”œâ”€â”€ trpc/                         # ğŸŸ¢ tRPC layer (API)
â”‚   â””â”€â”€ routers/
â”‚       â”œâ”€â”€ [entity].router.ts    # tRPC procedures
â”‚       â””â”€â”€ index.ts              # Router aggregation
â”œâ”€â”€ api-v1/                       # ğŸŸ¡ REST layer (legacy/specific)
â”œâ”€â”€ common/                       # Shared utilities
â”‚   â””â”€â”€ schemas/                  # Backend-only Zod schemas
â”œâ”€â”€ config/                       # Configuration
â”œâ”€â”€ telegram/                     # Telegram integration
â””â”€â”€ main.ts                       # App entry point
```

### Adding New Backend Feature
1. Create domain entity in `domain/[entity]/`
2. Create tRPC router in `trpc/routers/[entity].router.ts`
3. Register router in `trpc/routers/index.ts`
4. Add shared types to `libs/shared-types/` if needed

## Frontend Structure (web/)
```
web/src/
â”œâ”€â”€ app/                          # ğŸ”µ Next.js App Router
â”‚   â”œâ”€â”€ (routes)/                 # Route groups
â”‚   â”œâ”€â”€ layout.tsx                # Root layout
â”‚   â””â”€â”€ page.tsx                  # Home page
â”œâ”€â”€ components/                   # ğŸŸ¢ UI Components
â”‚   â”œâ”€â”€ ui/                       # Base UI (buttons, inputs)
â”‚   â””â”€â”€ [feature]/                # Feature-specific components
â”œâ”€â”€ features/                     # ğŸŸ¡ Feature modules
â”œâ”€â”€ hooks/                        # Custom React hooks
â”œâ”€â”€ stores/                       # Zustand stores
â”œâ”€â”€ contexts/                     # React contexts
â”œâ”€â”€ lib/                          # Utilities & helpers
â”œâ”€â”€ providers/                    # Provider components
â”œâ”€â”€ types/                        # TypeScript types
â””â”€â”€ generated/                    # Auto-generated (tRPC client)
```

### Adding New Frontend Feature
1. Create components in `components/[feature]/`
2. Create hooks in `hooks/use[Feature].ts`
3. Create store in `stores/[feature].store.ts` if needed
4. Add page in `app/[route]/page.tsx`

## Shared Types (libs/shared-types/)
```
libs/shared-types/src/
â”œâ”€â”€ base-schemas.ts               # Base Zod primitives
â”œâ”€â”€ schemas.ts                    # Complex DTOs
â””â”€â”€ index.ts                      # Public exports
```

### When to Use Shared Types
âœ… Type is used in BOTH frontend and backend
âœ… Type is part of API contract
âŒ Type is backend-only validation â†’ use `api/common/schemas/`
âŒ Type is frontend-only UI state â†’ use `web/src/types/`

## Key Patterns

### Service Layer (Backend)
```typescript
// domain/[entity]/[entity].service.ts
@Injectable()
export class EntityService {
  constructor(
    @InjectModel(Entity.name) private model: Model<Entity>,
    private otherService: OtherService,
  ) {}

  async create(dto: CreateEntityDto): Promise<Entity> {
    // Business logic here
  }
}
```

### tRPC Router (Backend)
```typescript
// trpc/routers/[entity].router.ts
export const entityRouter = router({
  getById: protectedProcedure
    .input(z.object({ id: z.string() }))
    .query(async ({ ctx, input }) => {
      return ctx.entityService.getById(input.id);
    }),
});
```

### Component Pattern (Frontend)
```typescript
// components/[feature]/FeatureCard.tsx
interface FeatureCardProps {
  data: FeatureData;
  onAction?: () => void;
}

export function FeatureCard({ data, onAction }: FeatureCardProps) {
  // Component logic
}
```

## File Naming

| Type | Convention | Example |
|------|------------|---------|
| Components | PascalCase | `VoteButton.tsx` |
| Hooks | camelCase with use | `useVoting.ts` |
| Services | PascalCase + .service | `vote.service.ts` |
| Schemas | kebab-case + .schema | `vote.schema.ts` |
| Routers | kebab-case + .router | `vote.router.ts` |
| Stores | kebab-case + .store | `vote.store.ts` |

## Module Dependencies
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           libs/shared-types             â”‚ â† Shared contracts
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   api/      â”‚ â—„â”€â”€â”€â”€â”€â–º â”‚   web/      â”‚
â”‚  (Backend)  â”‚  tRPC   â”‚ (Frontend)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Common Mistakes

âŒ Importing from `api/` in `web/` directly (use tRPC/REST)
âŒ Duplicating types instead of using shared-types
âŒ Putting business logic in routers (belongs in services)
âŒ Creating components in `app/` directory (use `components/`)