---
description: Posts, polls, comments, and voting business logic. Apply when working with content features.
globs:
  - "**/post*.ts"
  - "**/poll*.ts"
  - "**/comment*.ts"
  - "**/vote*.ts"
  - "**/rating*.ts"
alwaysApply: false
---

# Content Business Logic

> Complete rules for posts, polls, comments, and voting mechanics.

---

## Base Post

Main content type on the platform. All other types inherit from base post.

### User-Filled Fields

| Field | Required | Description |
|-------|----------|-------------|
| title | No | Post title (optional in schema) |
| description | No | Optional description |
| content | Yes | Main body text (required in schema) |
| images | No | Attached images (`images` array; legacy `imageUrl` for single image) |
| categories | No | From list defined by community admin |

### System Fields

| Field | Description |
|-------|-------------|
| createdAt | Creation timestamp |
| authorId | Creator user id |
| communityId | Community where post is published |
| beneficiaryId | Optional; effective beneficiary for withdrawal (defaults to author when unset) |
| metrics | Object including `score` (current merit total on post), `upvotes`, `downvotes`, `commentCount` |
| lifetimeCredits | Total merits ever credited to this post (votes, author top-up, tappalka wins); never decreased; used for closing summary |
| status, closedAt, closeReason | Lifecycle: active/closed, close time, reason (`manual`, `ttl`, `inactive`, `negative_rating`) |

URL for sharing is derived from publication id; there is no stored `permalink` field. Comments and votes are stored in separate collections (votes, comments), not embedded in the publication document.

---

## Poll

Conceptually similar to base post (content with time limit, no own rating, neutral votes only). In code, **Poll is a separate entity**: its own collection (`polls`) and schema with `question`, `options`, `expiresAt`, and metrics (`totalCasts`, `casterCount`, `totalAmount`). It is not a Publication subtype or a publication with `postType: 'poll'`.

### Differences from Base Post

| Characteristic | Base Post | Poll |
|----------------|-----------|------|
| Own rating | Yes | No |
| Weighted comments | Yes | Neutral only |
| Additional fields | — | Question, answer options |
| Time limit | No | Optional |

### Poll-Specific Fields

| Field | Description |
|-------|-------------|
| question | Poll question text |
| options | List of voting options |
| expiresAt | Voting close time (required in schema) |

### Poll Voting
- Poll creation uses `settings.pollCost` (community-level cost)
- Poll voting spends user merits by vote amount (wallet/quota rules apply)
- Vote weight = amount of merits spent
- After expiresAt, new votes are NOT accepted

---

## Post Rating

### Rating Calculation
- Rating is stored as `metrics.score` (sum of merits attached to the post through votes).
- Positive comments increase rating; negative comments decrease it.
- Rating CAN be negative.

### Merit Withdrawal from Post
- Author can withdraw merits from post rating to their wallet
- Upon withdrawal, post rating (metrics.score) decreases
- Withdrawal availability determined by community settings (`settings.allowWithdraw`)

### Negative Rating Consequences
- If rating (metrics.score) goes negative, the post can be closed with `closeReason: 'negative_rating'`.
- **Automatic deduction of the negative amount from the author's wallet after 24 hours is not implemented in the current code.** Author can close the post (manual close); no automatic 24h deduction runs.

---

## Post Lifecycle

```
┌─────────────┐
│   Create    │ ─── `settings.postCost` charged (wallet/quota by rules)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   Active    │ ─── receives votes, participates in tappalka
└──────┬──────┘
       │
       ├─────────────────────────────────────┐
       │                                     │
       ▼                                     ▼
┌─────────────┐                    ┌─────────────────┐
│  Forwarded  │                    │ Closed (archive)│
│ (to another)│                    │ cannot re-publish│
└─────────────┘                    └─────────────────┘
```

### Editing
- Available within `settings.editWindowMinutes` time window (default: 30 minutes after publication).
- The edit window can also be overridden per permission rule via `permissionRules[].conditions.canEditAfterMinutes` (0 = no time limit).
- After time expires — only closing or forwarding
- Edit history is stored in the `editHistory` array (`editedBy`, `editedAt`) on the publication.

### Post Closing
- Post removed from feed; saved in user's profile archive.
- **CANNOT be re-published.** Close reasons in code: `manual`, `ttl`, `inactive`, `negative_rating`. TTL and inactivity auto-close are implemented (`ttlDays`/`ttlExpiresAt`, `inactiveCloseDays`).
- Remaining merits on post can be withdrawn before closing

---

## Post Forwarding

### Forwarding Modes

| Mode | Description | When Used |
|------|-------------|-----------|
| **standard** | Forward without merits, original preserved | `settings.forwardRule` default |
| **project** | Forward with merits, original deleted | "Projects" → "MД" special case |

### Rules by Community Type

| From | To | Mode |
|------|-----|------|
| Global | Global | Configured by admin |
| Local | Any | ALWAYS copy without merits |
| "Projects" | "MД" | Transfer with merits |

### Restrictions
- For local communities, forwarding follows platform constraints (local → any = copy without merits)
- Local community lead CANNOT change this default

---

## Comments

### Comment Types

| Type | Effect | Paid From |
|------|--------|-----------|
| **Positive (Upvote)** | Merits transfer to post, rating increases | Quota → Wallet |
| **Neutral** | Text only, no merits | No weighted amount transfer |
| **Negative (Downvote)** | Merits removed from post, rating decreases, merits BURN | Wallet ONLY |

Weighted comments (votes) on publications are represented by the **Vote** entity (`targetType: 'publication'`, `targetId` = publication id). Vote has `amountQuota`, `amountWallet` (combined effect is the merit weight), optional comment text, and `direction: 'up' | 'down'`. A separate **Comment** entity exists for threaded discussions: it has `content`, `metrics.score`, `metrics.replyCount`, and `parentCommentId`; replies are stored as separate Comment documents with the same target and their `parentCommentId` set to the parent comment id.

### Comment Data Model (Vote as comment with weight)

| Field | Description |
|-------|-------------|
| amountQuota, amountWallet | Merits brought/removed (0 for neutral); effective weight = sum of these |
| direction | `'up'` or `'down'` (explicit vote direction in schema) |
| comment | Comment text (optional on Vote) |
| userId | Vote author |
| createdAt | Creation timestamp |
| targetType, targetId | Target publication (or vote for nested) |
| communityId | Community context (required in Vote schema) |
| images | Optional array of image URLs on Vote |

### Comment entity (threaded discussions)

| Field | Description |
|-------|-------------|
| content | Comment text (required) |
| metrics | Object with `score`, `upvotes`, `downvotes`, `replyCount` |
| parentCommentId | Optional; when set, this comment is a reply to that comment |
| authorId | Comment author |
| targetType, targetId | Target publication or parent comment |
| images | Optional array of image URLs |
| createdAt, updatedAt | Timestamps |

---

## Comment Costs

### Separate Comment Fee
- Current codebase does **not** implement a dedicated `commentFee` / `commentCost` setting.
- For comments/votes, balance changes come from vote amounts (`amountQuota` / `amountWallet`) and direction rules.
- Legacy docs mentioning fixed "0.1 merit comment fee" are outdated for current implementation.

### What Gets Paid
- Positive/negative weighted comments transfer/remove weighted merits.
- Neutral comments require text and zero amount in `neutralOnly` mode.
- Community restrictions are enforced through `settings.commentMode` and `votingSettings.currencySource`.

---

## Voting Rules

### Payment Sources

| Action | Source | Priority |
|--------|--------|----------|
| Upvote other's post | Quota → Wallet | Quota first |
| Downvote any post | Wallet ONLY | — |
| Vote for own post | Wallet ONLY | Quota forbidden |
| Vote for teammate's post | Configurable via `votingSettings` + permissions | Default: same as other's |

### Comment Mode (`settings.commentMode`)

| Mode | Allowed behavior |
|------|------------------|
| `all` | In current code: non-zero amount required (weighted in practice). |
| `neutralOnly` | Only neutral comments (`totalAmount = 0`) |
| `weightedOnly` | Only weighted comments (`totalAmount > 0`) |

`tappalkaOnlyMode` is deprecated and mapped to `commentMode='neutralOnly'` for compatibility.

### Restrictions by Post Type

| Post Type | Positive | Negative | Neutral |
|-----------|----------|----------|---------|
| Base post | ✅ | ✅ | ✅ |
| Poll | ❌ | ❌ | ✅ |

### Self-Voting
- Default: **PROHIBITED**
- Controlled via permissions (`permissionRules` / `canVoteForOwnPosts`)
- If enabled — wallet ONLY, never quota

### Teammate Voting
Teammates = members of same local communities as voter.

- Default: merits allowed, quota only for non-teammates
- Configurable per community

---

## Comment Workflow

```
┌─────────────────────────────────────────────────────────┐
│ User selects comment type                               │
├───────────────┬───────────────┬─────────────────────────┤
│   Positive    │   Neutral     │      Negative           │
└───────┬───────┴───────┬───────┴────────────┬────────────┘
        │               │                    │
        ▼               ▼                    ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────────────┐
│ Select weight │ │ Enter text    │ │ Select weight         │
│ (1+ merits)   │ │               │ │ (1+ merits)           │
└───────┬───────┘ └───────┬───────┘ └───────────┬───────────┘
        │               │                    │
        ▼               ▼                    ▼
┌─────────────────────────────────────────────────────────┐
│ Check balance (wallet/quota sufficient?)                │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│ Validate `commentMode`, `currencySource`, self-vote,    │
│ and direction constraints                                │
└───────────────────────────┬─────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ▼                   ▼                   ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────────────┐
│ Transfer to   │ │ Nothing       │ │ Remove from post      │
│ post rating   │ │               │ │ (merits BURN)         │
└───────────────┘ └───────────────┘ └───────────────────────┘
```

---

## Tappalka and Posts

### Participation Conditions
1. `tappalkaSettings.enabled = true`
2. Post rating ≥ `tappalkaSettings.minRating` (default 1)
3. Post rating ≥ author's stop-loss setting
4. Post not closed

### Exit from Tappalka
Post stops being shown if:
- Rating drops below minimum threshold
- Rating drops below author's stop-loss
- No funds to pay for showing (neither on post nor from author)
- If the post has `noAuthorWalletSpend: true`, the author wallet is not used for show cost; when all other sources are exhausted, the post stops being shown

### Stop-Loss
- Set by post owner
- Minimum rating threshold below which post not shown
- Protection from "draining" merits on shows of losing post

### IMPORTANT: Cannot Disable Tappalka Show
- Author **CANNOT** choose "don't show in tappalka"
- Only ways to remove post from tappalka:
  1. Set high stop-loss
  2. Set `noAuthorWalletSpend = true` (post exits once pool and rating down to stop-loss are exhausted; author wallet is not charged for shows)
  3. Close post and withdraw all merits

### What Post Gets in Tappalka
- When chosen by user: +`tappalkaSettings.winReward` (emission, not from user's wallet)
- Each show charges `tappalkaSettings.showCost` per post (winner and loser)

---

## Investments and Posts (Current v1)

### At Post Creation
- Investment contract is optional and available only when `settings.investingEnabled = true`.
- If enabled on post, `investorSharePercent` must be within community bounds:
  `settings.investorShareMin..settings.investorShareMax`.
- If `settings.requireTTLForInvestPosts = true`, investment-enabled posts must have TTL.

### During Tappalka Shows
- For investment-enabled posts, show-cost deduction priority is:
  `investmentPool` → `post rating` (respecting stop-loss) → `author wallet`.
- If all sources are exhausted, post stops participating in tappalka.

### On Withdraw / Close
- Withdrawal distributes by contract percent:
  investor share from withdrawn amount, remainder to author.
- On close, investment handling is processed by post-closing flow
  (pool return/distribution behavior depends on community close strategy).

---

## Project Community vs Project Post Type

### Projects Community (exists now)
- `Projects` is an existing priority/global community (`typeTag='team-projects'`).
- It supports publication flow, tappalka participation, and special transfer to МД.

### Project Post Type (v2.0 planned)

*Deferred to version 2.0 — requires verification mechanics development.*

### Concept
Assumes collecting and attracting resources for implementing a specific idea.

### Differences from Base Post
- Additional "resources" fields: money, help, etc. — everything needed for implementation
- Filled by user at creation

### Planned Logic (v2.0+)

**Project Statuses:**
- Idea
- In Progress
- Completed

**Completion Verification:**
- Author clicks "project completed"
- Project goes to completed listing
- Verifiers (schools, NGOs, trusted people) confirm
- Verifiers bear responsibility in amount of merits on post
- On fraud — fine deducted from their account

**Current Solution:**
Use "base post + poll" combination, provide place for resource list in post.

---

## Future Features

### Comments on Comments
- Comments on comments will work same as comments on posts (future).
- Comments will have their own merit rating.
- Withdrawal from own comment/vote: see Comment Merit Withdrawal below (implemented).

### Comment Merit Withdrawal
- Withdrawal of merits from one's own comment (vote) is implemented: `votes.withdrawFromVote` procedure in the votes router; authorization is enforced in the vote service (`canUserWithdraw` for targetType `'vote'`). If a comment (vote) is downvoted to negative score, same withdrawal/beneficiary rules apply as for posts; automatic 24h deduction from author wallet is not implemented.
