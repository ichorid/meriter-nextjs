---
description: MVP "Marathon of Good" specific business logic and community configurations. ALWAYS apply when working on MVP features.
globs:
  - "**/*.ts"
  - "**/*.tsx"
alwaysApply: true
---

# MVP "Marathon of Good" Business Logic

> Specific rules for current MVP implementation. Critical for understanding platform context.

---

## About MVP

**Marathon of Good** — platform for running a game organized by project partners.

**Target Audience:** Schoolchildren

**Game Goal:** Collect as many merits as possible and use them to promote "Images of Future" (posts in ОБ) that the user likes.

**Main currency:** Global merit. One wallet for МД, ОБ, Projects, Support. Quota is disabled in priority communities — tappalka and voting are the emission sources.

---

## MVP Terminology Mapping

| Universal Term | MVP Term |
|----------------|----------|
| Local community | Team group |
| Lead of local community | Team lead |
| Global community | Public group |

---

## Global Communities in MVP

MVP has **4 priority communities** (all use global merit, quota disabled):

| Community | typeTag | Uses global merit |
|-----------|---------|-------------------|
| МД | marathon-of-good | Yes |
| ОБ | future-vision | Yes |
| Projects | team-projects | Yes |
| Feedback | support | Yes |

### 1. Image of Future (ОБ / Obraz Budushchego)

**Main game community.** Participants publish their "images of future" and compete to promote them.

**Key Settings:**

| Setting | Value | Reason |
|---------|-------|--------|
| `settings.allowWithdraw` | **No** | Merits stay on post forever |
| `permissionRules` (self-vote) | **Enabled** | Can support own ОБ |
| `meritSettings.quotaEnabled` | No | Quota disabled in priority communities |
| `tappalkaSettings.enabled` | No | Only voting in this community |
| `settings.postCost` | 1 merit | Standard |
| `settings.pollCost` | 1 merit | Standard |
| `settings.commentMode` | `all` (weighted) | Standard voting/comments behavior |

**Implementation note:** Bootstrap does not set `allowWithdraw`; schema default is `true`. Set `settings.allowWithdraw = false` on the future-vision community to keep merits on posts. Polls: poll creation and casting are blocked for `future-vision` in current routers; `polls.getByCommunity` returns an empty list for this community.

**Special Feature:** Periodically administration rewards authors of highest-rated posts.

---

### 2. Marathon of Good (МД / Marafon Dobra)

**For reports on actually done good deeds.** Main source of merit earning through voting.

**Key Settings:**

| Setting | Value | Reason |
|---------|-------|--------|
| `settings.allowWithdraw` | **Yes** | Main earning method |
| `permissionRules` (self-vote) | No | Standard |
| `meritSettings.quotaEnabled` | **No** | Tappalka handles everything |
| `tappalkaSettings.enabled` | **Yes** | Main emission |
| `settings.investingEnabled` | **Yes** | Investment mechanics enabled in current v1 |
| `settings.investorShareMin/Max` | 1..99 | Contract bounds for investors |
| `settings.postCost` | 1 merit | Standard |
| `settings.pollCost` | 1 merit | Standard |
| `settings.commentMode` | `all` (weighted) | Standard voting/comments behavior |

**Implementation note:** There is no `rateMultiplier` field in the current community schema; multiplier behavior is planned only (see product docs). Investment lifecycle is controlled by `settings.requireTTLForInvestPosts`, `settings.maxTTL`, `settings.inactiveCloseDays`, and `settings.distributeAllByContractOnClose` when investing is enabled (see business-communities for full list).

**Planned Rates:** When additional public groups appear (e.g., entertainment content) — multiplier for MД will be ×2-×5, for entertainment ×0.1.

---

### 3. Projects

**For publishing ideas and projects "in progress".**

**Key Settings:**

| Setting | Value | Reason |
|---------|-------|--------|
| `settings.allowWithdraw` | **No** | Only after transfer to MД |
| `permissionRules` (self-vote) | **Enabled** | Can support own project |
| `meritSettings.quotaEnabled` | No | — |
| `tappalkaSettings.enabled` | **Yes** | Emission |
| `settings.postCost` | 1 merit | Standard |
| `settings.pollCost` | 1 merit | Standard |
| `settings.commentMode` | `all` (weighted) | Standard voting/comments behavior |

**Implementation note:** Defaults for typeTag `team-projects` (CommunityDefaultsService) deny participant `POST_PUBLICATION` and `CREATE_POLL` (lead-only) and set `votingSettings.spendsMerits`/`awardsMerits` to false. To allow participants to publish and collect merits as in the MVP flow, store DB overrides: set `permissionRules` (or rule overrides) to allow participant `POST_PUBLICATION` and `CREATE_POLL`, and set merit/voting settings so that votes spend and award merits as needed.

**Special Feature:** When project is completed, post can be **transferred** to MД community — and there all earned merits can be withdrawn. This is the ONLY case of transfer with merits.

---

### 4. Feedback

**For suggestions, questions, and wishes to administration.**

**Key Settings:**

| Setting | Value | Reason |
|---------|-------|--------|
| `settings.postCost` | **0** | Free feedback |
| `settings.pollCost` | **0** | Free feedback polls |
| `meritSettings.quotaEnabled` | No | — |
| `permissionRules` (vote for regular users) | **Override to disable** | Default allows participant VOTE; for superadmin-only credits, configure overrides |
| `settings.allowWithdraw` | **Yes** | Can withdraw to wallet |
| `tappalkaSettings.enabled` | No | — |
| `settings.commentMode` | `neutralOnly` (recommended) | Prevent weighted user voting in support context |

**Special Feature:** To have merits credited only by superadmin, configure permission overrides (default rules allow participant VOTE). Withdrawing merits works as usual where allowed.

**Note:** If "spamming" starts — fee may be enabled.

---

## Settings Summary Table

| Setting | Default | ОБ | МД | Projects | Feedback | Local |
|---------|---------|----|----|----------|----------|-------|
| `settings.allowWithdraw` | Yes | **No** | Yes | **No** | Yes | Config |
| `permissionRules` self-vote | Config | **Yes** | No | **Yes** | No | Config |
| `votingSettings` teammate rules | Config | Yes | Yes | Yes | — | Config |
| `meritSettings.quotaEnabled` | Yes | No | No | No | No | Config |
| rateMultiplier (planned, not in schema)(2) | — | — | — | — | — | — |
| `settings.postCost` | 1 | 1 | 1 | 1 | **0** | Config |
| `settings.pollCost` | 1 | 1 | 1 | 1 | **0** | Config |
| `settings.commentMode` | all | all | all | all | neutralOnly* | Config |
| `tappalkaSettings.enabled` | No | No | **Yes** | **Yes** | No | Config |
| `settings.investingEnabled` | No | No | **Yes** | No | No | Config |
| `settings.investorShareMin/Max` | 1..99 | — | 1..99 | — | — | Config |
| `settings.editWindowMinutes` | 30 min | 30 min | 30 min | 30 min | 30 min | Config |
| `settings.forwardCost` | 1 | 1 | 1 | 1 | 1 | Config |

\* Recommended MVP configuration for support context.

(2) `rateMultiplier` is not present in community schema; planned for future.

(3) For `typeTag === 'future-vision'`, effective daily quota is forced to 0 in code (quota-reset.service); priority communities may still have `meritSettings.quotaEnabled` from defaults unless overridden in DB.

**Self-vote (code):** Effective self-voting is enforced by `permissionRules[].conditions.canVoteForOwnPosts` when present in DB. CommunityDefaultsService does not set this condition for priority communities; when absent, self-voting is governed by currency constraints (e.g. wallet-only allows self-vote; quota-only or no quota restricts it). To match MVP table (ОБ/Projects allow, МД/Feedback disallow), store the appropriate rule overrides in DB.

---

## Main User Flow

### 1. Registration
1. Select authorization method
2. Fill profile (name, about)
3. Optionally: enter invite code
4. Automatic:
   - "Member" (role `participant`) in all global communities
   - Welcome merits to **global wallet** (amount from platform setting `welcomeMeritsGlobal`; default 0, typically 100 for MVP)
   - Additional role by invite code (if any)

### 2. Publishing Ideas
- User publishes their images of future in **ОБ**
- Goal: collect maximum merits for their image

### 3. Earning Merits

**Method A: Good Deeds (МД)**
1. Do a good deed in real life
2. Post report in **МД** community
3. Receive positive comments from others
4. Withdraw earned merits to **global wallet**
5. Use to support posts in ОБ (same wallet)

**Method B: Projects**
1. Post idea/project in **Projects** community
2. Collect merits through comments (cannot withdraw)
3. Complete project in real life
4. Transfer post to **МД**
5. Withdraw all earned merits

**Method C: Tappalka**
1. Participate in tappalka (МД or Projects)
2. Get 1 merit for 10 comparisons
3. Use to support posts

**Withdrawal (code):** Withdrawing merits from a post to the author's wallet uses `publications.withdraw`; it is gated by `settings.allowWithdraw`. `wallets.withdraw` and `wallets.transfer` exist in the API but return `NOT_IMPLEMENTED` in the current codebase.

### 4. Spending Merits
- Pay fee for publications and comments
- Positive comments on posts in ОБ
- Participate in polls

### 5. Teams (Optional)
- Create local community (team group)
- Invite like-minded people
- Communicate, organize activities

### 6. Feedback
- Questions and suggestions — to **Feedback** community
- Superadmin can credit merits for valuable feedback

---

## MVP Roles

### Basic Path
```
Registration
    │
    ▼
Member of all global communities
    │
    ├──► Join local ──► Team member
    │
    └──► Create local ──► Team lead
```

### Administrative Roles
- **Global community lead** — given to organizers
- **Superadmin** — technical team and main organizers

---

## Local Communities in MVP

### Team Groups
- Created by users
- All settings at lead's discretion
- Own internal currency (separate from global merits)

### Restrictions
- Post forwarding — ALWAYS copy without merits
- Lead CANNOT delete community — only request

---

## Implementation Checklist

### Community Initialization
- [x] Create "Image of Future" (ОБ) with MVP settings
- [x] Create "Marathon of Good" (МД) with MVP settings
- [x] Create "Projects" with MVP settings
- [x] Create "Feedback" with MVP settings
- [x] Enable tappalka for МД and Projects
- [x] Disable quota for priority communities (tappalka as emission source)
- [x] Enable investing for МД (`settings.investingEnabled = true`)
- [ ] Set `settings.allowWithdraw = false` for future-vision (ОБ) if not set by bootstrap

### User Registration
- [x] Standard registration flow
- [x] Auto-join all 4 global communities
- [x] Credit welcome merits to global wallet (amount from `welcomeMeritsGlobal`; typically 100 for MVP)
- [x] If invite code: process additional role/community

### Post Transfer from Projects to МД
- [x] Check post is in Projects
- [x] Check target is МД
- [x] Transfer mode = WITH merits: **source** community (team-projects) must have `settings.forwardRule = 'project'` (bootstrap does not set this)
- [x] Delete original from Projects
- [x] Create new in МД with preserved rating/metrics
- [x] Post becomes withdrawable by МД rules
- [ ] Ensure team-projects community has `settings.forwardRule = 'project'` for transfer-with-merits (if not set at creation)

---

## MVP Success Metrics

### Functional
- [x] User can register and receive starting merits
- [x] User can publish posts in all global communities
- [x] User can vote for posts (positive/negative)
- [x] Tappalka works and credits merits
- [x] Post forwarding from Projects to МД works
- [x] Local community creation works
- [x] Investments in МД are enabled and operational (v1 scope)

### Economic
- [x] Post and poll costs are deducted (`settings.postCost`, `settings.pollCost`)
- [ ] Separate comment fee is deducted (not implemented as dedicated `commentFee`)
- [x] Emission through tappalka works
- [x] Merit withdrawal from posts works where allowed (`settings.allowWithdraw`)
