---
description: Users, roles, permissions, and registration business logic. Apply when working with user-related features.
globs:
  - "**/user*.ts"
  - "**/role*.ts"
  - "**/permission*.ts"
  - "**/auth*.ts"
  - "**/invite*.ts"
alwaysApply: false
---

# Users and Permissions Business Logic

> Complete rules for user profiles, roles, permissions, and registration.

---

## User Data Model

### User-Filled Fields

| Field | Required | Description |
|-------|----------|-------------|
| displayName | Yes | Display name (User schema) |
| profile.about | No | Short description; optional in UserProfileSchema (shared-types). Backend user create does not set it. |
| avatarUrl | No | Profile image URL |
| profile.contacts | No | Contact methods (email, messenger); part of UserProfile |
| username | No | Optional login handle |
| firstName, lastName | No | Optional name parts |
| profile.bio | No | Optional bio (same semantic area as about) |
| profile.location | No | Optional (region, city) |
| profile.website | No | Optional URL |
| profile.educationalInstitution | No | Optional |
| profile.isVerified | No | Optional verification flag |

### System Fields

| Field | Description |
|-------|-------------|
| globalRole | Optional; only `superadmin` in code (User.globalRole) |
| communityMemberships | Array of community IDs (User schema) |
| communityTags | Array of tags (User schema) |
| meritStats | Optional; per-community merit summary (User schema) |
| authenticators | Optional; passkeys (User schema) |
| teamId | Optional; in shared-types UserSchema only (not in backend Mongoose user schema) |

Roles are stored in **UserCommunityRole** (collection `user_community_roles`), not on User. Balances are in **Wallet**; favorites in **Favorite**; quota in merit/quota logic; closed posts in **Publication** with `status: 'closed'` and `authorId`.

---

## Roles

Roles are **COMMUNITY-SPECIFIC** — user can have different roles in different communities.

### Participant (UI may show as "Member")
**Base role.** In code the role value is `participant`. Assigned upon joining a community. (Role `viewer` has been removed; all users are `participant` by default — see user-community-role.schema.ts.)

**Rights:**
- Publish posts (if allowed by settings)
- Comment on posts
- Vote for posts
- Participate in polls
- Participate in tappalka
- Create local communities

### Lead (Local Community)
**Administrator of local community.** Creator or appointed by them.

**Rights (in addition to member):**
- Access to community settings
- Member management
- Content moderation
- Credit merits to members

**Restrictions:**
- CANNOT delete community (only request from administration; request flow not implemented)
- CANNOT change post forwarding mode (always copy without merits)

### Lead (Global Community)
**Appointed by superadmin.** Administers specific global community. In code this is the same **lead** role (`UserCommunityRole.role: 'lead'`) for that community; there is no separate role type.

**Rights:**
- All lead rights for their global community
- Configure global community parameters
- Manage post categories

### Superadministrator
**Full platform access.**

**Rights:**
- Administrator of ALL global communities
- Access to settings of ALL local communities
- Create global communities
- Appoint global community administrators
- Direct merit credit to ANY user
- Configure rates (multipliers) for communities
- Delete communities

---

## Community Membership Rules

### Joining
- User automatically becomes member of **ALL global communities** at registration
- Joins local communities voluntarily

### Multiple Membership
- User can be member of **ANY number** of communities
- User can be lead of **ANY number** of communities

### Leaving
- From local community — can leave at will
- From global community — **CANNOT** leave

### Community Deletion
- Lead **CANNOT** delete community independently
- Can only submit deletion request to administration (this flow is not implemented — no dedicated API)

---

## Registration

### Registration Process

```
┌─────────────────────────────────────────────────────────┐
│ 1. Select authorization method                          │
│    (Yandex / SMS / Call / E-mail / Telegram / Google /  │
│     Passkey)                                            │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│ 2. Fill profile                                         │
│    - Display name / displayName (required)              │
│    - About / profile.about (optional)                   │
│    - Avatar / avatarUrl (optional)                      │
│    - Contacts / profile.contacts (optional)             │
│    - Invite code (optional)                             │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│ 3. Automatic actions                                    │
│    - participant role in all global communities         │
│    - Welcome merits to global wallet (platform setting  │
│      welcomeMeritsGlobal, e.g. 100)                     │
│    - Additional role by invite code (if entered)        │
└─────────────────────────────────────────────────────────┘
```

### Starting Merits
At registration the user receives welcome merits to the **global wallet**. The amount is set by the platform setting **welcomeMeritsGlobal** (e.g. 100).

---

## Invite Codes

> **Status:** Temporary workaround. Will be replaced with full member management system.

### Current Implementation
Invite codes — main tool for granting roles to users.

**Code Types:**

| Type | Effect |
|------|--------|
| `superadmin-to-lead` | Grants lead role in target community (issued by superadmin) |
| `lead-to-participant` | Invites/adds participant to community (issued by lead) |

**Schema (code):** Invite has `code`, `type`, `createdBy`, `communityId`, and optionally `targetUserId`, `targetUserName`, `usedBy`, `usedAt`, `expiresAt`, `isUsed` (see InviteSchema in shared-types).

### Current Implementation Issues
- Create confusion when forwarding
- Inconvenient for team management

### Planned Replacement (v1.5+)
"Add to team" button for leads:
- Search users by name (like GitHub)
- Direct community invitation
- No need to generate and pass codes

---

## Authorization

### Implemented Methods
- Yandex
- SMS
- Call
- E-mail (including magic-link flow)
- Telegram (feature/config controlled)
- Google OAuth (feature/config controlled)
- Passkey/WebAuthn (feature/config controlled, AUTHN_ENABLED)
- Other OAuth providers (e.g. VK, Apple) are available in config and can be enabled (api config/configuration.ts)

### Planned Methods
- Additional messengers/providers beyond current set

### Future (When Valuable Resources Appear)
- Authorization via Gosuslugi (Government Services)
- For withdrawing material values
- Will allow identity verification

---

## Lead Change

> **Status:** Partially implemented.

### Current Mechanics (Implemented)
- Superadmin can assign a user as lead of a selected community (`users.assignLead`).
- UI exists: `AssignLeadDialog` (`web/src/components/organisms/Profile/AssignLeadDialog.tsx`) and `useAssignLead` (`web/src/hooks/api/useTeams.ts`) in web client.

### Planned / Not Yet Implemented
- Lead self-transfer flow initiated by current lead
- Appointing additional lead by lead without superadmin action
- Full governance workflow for lead replacement

---

## Implementation Rules

### Role Assignment
```
1. On registration:
   - Create user record
   - Assign participant role to all global communities
   - Credit welcome merits to global wallet (amount from platform setting, e.g. 100)
   - Process invite code if provided

2. On community join:
   - Assign participant role
   - Credit welcome merits (if configured)

3. On community creation:
   - Create community
   - Assign "Lead" role to creator
```

### Permission Checks
```
For each action:
1. Get user roles in target community
2. Check action permission for role
3. Check community settings for action
4. Return allowed/denied
```

### Permission Hierarchy
```
Superadmin (User.globalRole) > Lead (UserCommunityRole) > Participant (UserCommunityRole)
```
Global community administrator is implemented as **lead** for that community; there is no separate role value.

### Special Permission Cases
```
- Self-voting: permissionRules[].conditions.canVoteForOwnPosts (per role/action)
- Teammate voting: votingSettings.votingRestriction ('any' | 'not-same-team')
- Merit withdrawal: settings.allowWithdraw
- Post publishing: permissionRules for action `post_publication` (ActionType.POST_PUBLICATION); no single canPublish flag. Full conditions: PermissionRuleConditionsSchema in libs/shared-types/src/schemas.ts
```

---

## Role-Based Access Control

### Permission Matrix

| Action | Participant | Lead | Lead (global) | Superadmin |
|--------|--------|------|--------------|------------|
| Publish posts | ✓* | ✓ | ✓ | ✓ |
| Comment | ✓* | ✓ | ✓ | ✓ |
| Vote | ✓* | ✓ | ✓ | ✓ |
| Participate in tappalka | ✓ | ✓ | ✓ | ✓ |
| Create local community | ✓ | ✓ | ✓ | ✓ |
| Manage members | ✗ | ✓ | ✓ | ✓ |
| Edit settings | ✗ | ✓ | ✓ | ✓ |
| Moderate content | ✗ | ✓ | ✓ | ✓ |
| Credit merits | ✗ | ✓ | ✓ | ✓ |
| Manage categories | ✗ | ✗ | ✓ | ✓ |
| Configure rates | ✗ | ✗ | ✗ | ✓ |
| Create global community | ✗ | ✗ | ✗ | ✓ |
| Delete community | ✗ | ✗ | ✗ | ✓ |

*In code: role is `participant`. Allowed only if community permissionRules grant the action for that role (e.g. action `post_publication` for publishing); see action-types.constants.ts and permission.service.ts.

---

## User Activity Tracking

The User schema does **not** store activity metrics (posts_count, comments_count, votes_given, etc.). **meritStats** (optional) on User holds a per-community merit summary. Other activity (favorites, closed posts, quota) lives in separate collections/services.
