---
description: Community types, settings, and interaction rules. Apply when working with community features.
globs:
  - "**/communit*.ts"
  - "**/group*.ts"
  - "**/settings*.ts"
alwaysApply: false
---

# Communities Business Logic

> Complete rules for community types, settings, and interactions.

---

## Community Types

### Priority Communities (use Global Merit)

Communities that are treated as priority context. Includes:
- МД (Marathon of Good), ОБ (Image of Future), Projects, Support (Feedback)

**Definition:** `typeTag in ['marathon-of-good', 'future-vision', 'team-projects', 'support']` OR `isPriority === true`

**Characteristics:**
- Users are auto-added to base priority communities by backend sync logic.
- Priority communities use global merit context for voting, investment, tappalka rewards, and withdrawals.
- Fee routing is operation-specific (see "Action Payment Rules" below).
- No dedicated self-leave API is implemented in current routers (applies generally, including priority communities).

### Global Communities (Public Groups)

Includes platform base communities and other non-team communities.

**Important implementation facts:**
- Priority base communities are ensured by backend bootstrap logic.
- `isPriority` can only be set by superadmin.
- Reserved internal `global` community (`GLOBAL_COMMUNITY_ID`) is system-managed, uses `typeTag: 'global'`, and is excluded from user-facing community lists.
- `typeTag: 'global'` is reserved for internal global-merit storage community.
- Backend enforces reserved creation path: `typeTag: 'global'` is only valid for the reserved `GLOBAL_COMMUNITY_ID`.
- Community creation is available to authenticated users; it is not admin-only.

### Local Communities (Private Groups)

User-created team communities (`typeTag: 'team'`).

**Characteristics:**
- Team membership uses invite/request flows (team invitations + join requests).
- Voting/investment/tappalka wallet routing uses local community context (non-priority behavior).
- Wallet routing is operation-specific (see "Action Payment Rules" below).
- No dedicated self-leave endpoint is implemented.
- Membership removal is implemented via admin/lead-only `removeMember` API.
- "Lead requests deletion from administration" flow is not implemented as a dedicated API feature.

---

## Community Data Model

### User-Filled Fields

| Field | Description |
|-------|-------------|
| Name | Display name of community |
| Description | Text description of goals and rules |
| Avatar | Community image (`avatarUrl`) |
| Cover | Background image (`coverImageUrl`) |
| Currency Name | Community currency labels (`settings.currencyNames`) |
| Type Tag | Community kind (`typeTag`, e.g. `team`, `future-vision`, `marathon-of-good`, `support`, `team-projects`, `political`, `housing`, `volunteer`, `corporate`, `custom`) |
| Hashtags | Community hashtag list (`hashtags`) |
| Hashtag Descriptions | Optional hashtag descriptions (`hashtagDescriptions`) |

**Implementation note:** Internal `typeTag: 'global'` exists in backend for `GLOBAL_COMMUNITY_ID`, but it is system-managed and not part of user-facing shared `CommunitySchema.typeTag` enum.

### System Fields

| Field | Description |
|-------|-------------|
| createdAt / updatedAt | Timestamps |
| members | Legacy member IDs list (current role source is `UserCommunityRole`) |
| isActive | Community active flag |
| isPriority | Priority flag used in sorting and global-merit logic |
| lastQuotaResetAt | Last quota reset timestamp |
| settings | Base settings block |
| permissionRules | Role/action allow/deny rules (custom overrides) |
| meritSettings / votingSettings / tappalkaSettings | Optional custom override blocks (effective values are merged with defaults at runtime) |
| linkedCurrencies | Optional linked currency IDs |

---

## Community Settings (Complete List)

Current community configuration is split into multiple blocks:

```text
Community
├── settings          # base community behavior and costs
├── meritSettings     # quota/earning/spending config
├── votingSettings    # voting conversion/restrictions/currency source
├── tappalkaSettings  # tappalka parameters
└── permissionRules   # role->action allow/deny (replaces old canPublish/whoCanVote toggles)
```

**Runtime behavior note:**
- Effective `permissionRules`, `meritSettings`, and `votingSettings` are resolved by backend defaults service and merged with DB overrides.
- API may still return/store legacy rule blocks (`postingRules`, `votingRules`, `visibilityRules`, `meritRules`) for backward compatibility.

### `settings` (CommunitySettingsSchema)

#### Posting / core
| Field | Description | Default |
|------|-------------|---------|
| `currencyNames` | Currency labels (`singular/plural/genitive`) | required |
| `dailyEmission` | Daily emission baseline | `10` |
| `language` | Community language | `en` |
| `postCost` | Post creation cost | `1` |
| `pollCost` | Poll creation cost | `1` |
| `forwardCost` | Forward action cost | `1` |
| `editWindowMinutes` | Participant edit window (`0` = unlimited) | `30` |
| `allowEditByOthers` | Allow participants editing others' posts | `false` |
| `canPayPostFromQuota` | Allow post payment from quota | `false` |
| `allowWithdraw` | Stored community flag for withdrawal policy (`true` by default); current withdrawal enforcement in routers/services is partial and type-specific | `true` |
| `forwardRule` | Forward behavior: `standard` or `project` | `standard` |

#### Investing / comment mode
| Field | Description | Default |
|------|-------------|---------|
| `investingEnabled` | Enable investments for posts in community | `false` |
| `investorShareMin` | Minimum contract percent for investors | `1` |
| `investorShareMax` | Maximum contract percent for investors | `99` |
| `commentMode` | `all` \| `neutralOnly` \| `weightedOnly` | `all` |
| `tappalkaOnlyMode` | Deprecated alias for `commentMode='neutralOnly'` | `false` |

#### Investment lifecycle controls
| Field | Description | Default |
|------|-------------|---------|
| `requireTTLForInvestPosts` | Require TTL when post has investment enabled | `false` |
| `maxTTL` | Max post TTL in days (`null/undefined` = no limit) | optional |
| `inactiveCloseDays` | Auto-close after N days without earnings | `7` |
| `distributeAllByContractOnClose` | Close distribution strategy toggle | `true` |

### `meritSettings` (CommunityMeritSettingsSchema)
| Field | Description |
|------|-------------|
| `dailyQuota` | Daily quota amount |
| `quotaRecipients` | Roles that receive quota |
| `canEarn` | Whether earning merits is allowed |
| `canSpend` | Whether spending merits is allowed |
| `startingMerits` | Starting merits for member context |
| `quotaEnabled` | Quota enabled flag |

### `votingSettings` (CommunityVotingSettingsSchema)
| Field | Description |
|------|-------------|
| `spendsMerits` | Voting consumes merits |
| `awardsMerits` | Voting awards merits |
| `meritConversion` | Conversion to target community currency |
| `votingRestriction` | `any` or `not-same-team` |
| `currencySource` | `quota-and-wallet` \| `quota-only` \| `wallet-only` |

### `tappalkaSettings` (TappalkaSettingsSchema)
| Field | Description | Default |
|------|-------------|---------|
| `enabled` | Tappalka enabled | `false` |
| `categories` | Allowed category IDs (empty = all) | `[]` |
| `winReward` | Reward for chosen post | `1` |
| `userReward` | Reward for user progress cycle | `1` |
| `comparisonsRequired` | Comparisons needed for user reward | `10` |
| `showCost` | Cost per post show in comparison | `0.1` |
| `minRating` | Minimum rating to participate | `1` |
| `onboardingText` | Optional custom onboarding copy | optional |

### Permissions and old field names
- Role/action permissions are controlled by `permissionRules` (effective rules are defaults + DB overrides).
- Legacy-style names like `canPublish`, `whoCanVote`, `canVoteSelf`, `canVoteTeammates` are not top-level `settings` fields.
- Legacy rule blocks (`postingRules`, `votingRules`, `visibilityRules`, `meritRules`) may still appear in API payloads for backward compatibility.
- Prefer documenting/using current schema fields from `CommunitySettingsSchema`, `CommunityMeritSettingsSchema`, `CommunityVotingSettingsSchema`, and `TappalkaSettingsSchema`.

---

## Settings Import/Export

**Status:** Not implemented as a dedicated product feature in current codebase.

If needed in future, treat this as planned work and define explicit API/storage format first.

---

## Wallet API Status (Current)

- `wallets.withdraw` and `wallets.transfer` procedures exist but currently return `NOT_IMPLEMENTED`.
- Do not document these two operations as available user flows yet.

---

## Global and Local Community Interaction

### Action Payment Rules
- Costs are configured by `settings.postCost`, `settings.pollCost`, `settings.forwardCost`.
- `publications.create`: wallet fee is debited from `GLOBAL_COMMUNITY_ID`; optional quota part is possible when `settings.canPayPostFromQuota=true`.
- `polls.create`: wallet fee is debited from the poll community wallet; for `marathon-of-good`/`future-vision`, debit is synchronized between both community wallets by router helper logic.
- `polls.cast`: wallet amount is debited from the poll community wallet; for `marathon-of-good`/`future-vision`, debit is synchronized between both community wallets by router helper logic.
- `proposeForward`: `settings.forwardCost` is charged from `GLOBAL_COMMUNITY_ID` (participant flow).
- `forward` (lead/superadmin direct forward): no forward fee is charged in current implementation.
- Withdrawals are routed to `GLOBAL_COMMUNITY_ID` by merit resolver (`operationType='withdrawal'`).
- Current `publications.withdraw` logic does not enforce `settings.allowWithdraw` as a generic gate; it enforces a hard restriction for `future-vision` and permission checks via vote service.
- Voting/tappalka/investment wallet routing uses merit resolver: global wallet for priority communities, source community wallet for non-priority communities.
- Priority community detection: `typeTag in ['marathon-of-good', 'future-vision', 'team-projects', 'support']` or `isPriority=true`.
- Voting source restrictions are configured through `votingSettings.currencySource` (with backward-compatible logic in domain services).
- In several router flows (`publications.create`, `polls.create`, `proposeForward`), debit is attempted after entity creation and deduction errors are swallowed; this is best-effort charging, not strict all-or-nothing transactionality.

### Forwarding Between Communities

| Case | Behavior |
|------|----------|
| Lead/superadmin forward | Direct `forward` operation (no forward fee in current implementation) |
| Participant forward from team community | `proposeForward` flow (lead approval path) |
| Proposal source constraint | `proposeForward` is allowed only when source community is `typeTag='team'` |
| Proposal fee | `settings.forwardCost` is charged in `proposeForward` from `GLOBAL_COMMUNITY_ID` |
| Forwardable post types | `basic` and `project`; `poll` forwarding is rejected |
| Target compatibility | Target community is validated via post-type support check before forward/proposal |
| Forward mode | Defined by source `settings.forwardRule`: `standard` or `project` |
| `standard` mode | Create copy in target, keep original |
| `project` mode | Transfer votes to new post and soft-delete original |

**Note:** Current code does not enforce a single hardcoded "Projects → МД only" transfer path.

---

## Implementation Notes

### Community Creation
```
1. Validate required fields
2. Create community for authenticated user
3. Apply base settings payload
4. Assign creator as lead and member
5. Create creator wallet in community context
6. `isPriority` can be set only by superadmin
7. Reserved internal `global` community is system-managed
```

### Member Join Logic
```
Base priority communities:
- Users are auto-added by backend ensure/sync logic
- Wallets and roles are provisioned during sync

Team communities (`typeTag='team'`):
- Join via invitation acceptance OR join request approval
- Invitation flow is implemented (create/accept/reject)
- Join-request flow is implemented (submit/approve/reject)
- No dedicated self-leave endpoint is implemented in current API
- Membership removal is available via admin/lead `removeMember`
```

### Current Implemented Constraints
- `future-vision`: poll creation and poll casting are blocked in current routers.
- `future-vision`: `polls.getByCommunity` returns an empty list in current routers.
- `team-projects`: default permission rules deny participant `POST_PUBLICATION` and `CREATE_POLL` (lead-only posting/poll creation by defaults service).
- Internal `global` community is excluded from user-facing community queries/lists.
- Base community `typeTag` single-instance constraints are enforced for `future-vision`, `marathon-of-good`, `team-projects`, and `support`.
- Startup bootstrap includes duplicate cleanup for `team-projects` communities (keeps one, removes extras).

### Settings Validation
```
- `investorShareMin` and `investorShareMax` must be within 1..99 and `min <= max`
- `commentMode` must be one of `all | neutralOnly | weightedOnly`
- `votingRestriction` is normalized to `any | not-same-team` in update/validation flow
- Deprecated `tappalkaOnlyMode` maps to `commentMode='neutralOnly'` for backward compatibility
```

---

## Future Features (v2.0+)

Status: planned only (not implemented in current codebase).

### Community Wallet
Local community will be able to act as participant in global communities:
- Admin posts on behalf of community
- Community receives and spends merits
- Separate balance from members' personal wallets
