---
description: Community types, settings, and interaction rules. Apply when working with community features.
globs:
  - "**/communit*.ts"
  - "**/group*.ts"
  - "**/settings*.ts"
alwaysApply: false
---

# Communities Business Logic

> Complete rules for community types, settings, and interactions.

---

## Community Types

### Priority Communities (use Global Merit)

Communities that share the user's **global wallet**. Includes:
- МД (Marathon of Good), ОБ (Image of Future), Projects, Support (Feedback)

**Definition:** `typeTag in ['marathon-of-good', 'future-vision', 'team-projects', 'support']` OR `isPriority === true`

**Characteristics:**
- All users are members by default (for main MVP communities)
- One wallet for all — earning in МД = spending in ОБ, etc.
- Fee, voting, withdrawal, tappalka — all from global wallet
- User CANNOT leave (for MVP global communities)

### Global Communities (Public Groups)

Created by platform administration. May include both priority and non-priority communities.

**Priority communities** (МД, ОБ, Projects, Support) use **global merit** — one wallet shared across them all. See above.

### Local Communities (Private Groups)

Created and managed by users.

**Characteristics:**
- Have their OWN merit (separate from global)
- Full set of settings available to lead
- User can be member of ANY number of local communities
- User can be lead of ANY number of communities
- User can voluntarily leave any local community
- Lead CANNOT delete community — only request deletion from administration

---

## Community Data Model

### User-Filled Fields

| Field | Description |
|-------|-------------|
| Name | Display name of community |
| Description | Text description of goals and rules |
| Avatar | Community image |
| Cover | Background image |
| Currency Name | What merits are called in this community |
| Type | Local or Global |

### System Fields

| Field | Description |
|-------|-------------|
| createdAt | Creation timestamp |
| members | Users who are members of community |
| posts | Posts belonging to this community |
| settings | Configuration (see below) |

---

## Community Settings (Complete List)

Current community configuration is split into multiple blocks:

```text
Community
├── settings          # base community behavior and costs
├── meritSettings     # quota/earning/spending config
├── votingSettings    # voting conversion/restrictions/currency source
├── tappalkaSettings  # tappalka parameters
└── permissionRules   # role->action allow/deny (replaces old canPublish/whoCanVote toggles)
```

### `settings` (CommunitySettingsSchema)

#### Posting / core
| Field | Description | Default |
|------|-------------|---------|
| `currencyNames` | Currency labels (`singular/plural/genitive`) | required |
| `dailyEmission` | Daily emission baseline | `10` |
| `language` | Community language | `en` |
| `postCost` | Post creation cost | `1` |
| `pollCost` | Poll creation cost | `1` |
| `forwardCost` | Forward action cost | `1` |
| `editWindowMinutes` | Participant edit window (`0` = unlimited) | `30` |
| `allowEditByOthers` | Allow participants editing others' posts | `false` |
| `canPayPostFromQuota` | Allow post payment from quota | `false` |
| `allowWithdraw` | Allow withdrawing merits from own posts | `true` |
| `forwardRule` | Forward behavior: `standard` or `project` | `standard` |

#### Investing / comment mode
| Field | Description | Default |
|------|-------------|---------|
| `investingEnabled` | Enable investments for posts in community | `false` |
| `investorShareMin` | Minimum contract percent for investors | `1` |
| `investorShareMax` | Maximum contract percent for investors | `99` |
| `commentMode` | `all` \| `neutralOnly` \| `weightedOnly` | `all` |
| `tappalkaOnlyMode` | Deprecated alias for `commentMode='neutralOnly'` | `false` |

#### Investment lifecycle controls
| Field | Description | Default |
|------|-------------|---------|
| `requireTTLForInvestPosts` | Require TTL when post has investment enabled | `false` |
| `maxTTL` | Max post TTL in days (`null/undefined` = no limit) | optional |
| `inactiveCloseDays` | Auto-close after N days without earnings | `7` |
| `distributeAllByContractOnClose` | Close distribution strategy toggle | `true` |

### `meritSettings` (CommunityMeritSettingsSchema)
| Field | Description |
|------|-------------|
| `dailyQuota` | Daily quota amount |
| `quotaRecipients` | Roles that receive quota |
| `canEarn` | Whether earning merits is allowed |
| `canSpend` | Whether spending merits is allowed |
| `startingMerits` | Starting merits for member context |
| `quotaEnabled` | Quota enabled flag |

### `votingSettings` (CommunityVotingSettingsSchema)
| Field | Description |
|------|-------------|
| `spendsMerits` | Voting consumes merits |
| `awardsMerits` | Voting awards merits |
| `meritConversion` | Conversion to target community currency |
| `votingRestriction` | `any` or `not-same-team` |
| `currencySource` | `quota-and-wallet` \| `quota-only` \| `wallet-only` |

### `tappalkaSettings` (TappalkaSettingsSchema)
| Field | Description | Default |
|------|-------------|---------|
| `enabled` | Tappalka enabled | `false` |
| `categories` | Allowed category IDs (empty = all) | `[]` |
| `winReward` | Reward for chosen post | `1` |
| `userReward` | Reward for user progress cycle | `1` |
| `comparisonsRequired` | Comparisons needed for user reward | `10` |
| `showCost` | Cost per post show in comparison | `0.1` |
| `minRating` | Minimum rating to participate | `1` |
| `onboardingText` | Optional custom onboarding copy | optional |

### Permissions and old field names
- Role/action permissions are now controlled by `permissionRules`.
- Legacy-style names like `canPublish`, `whoCanVote`, `canVoteSelf`, `canVoteTeammates` are not top-level `settings` fields.
- Prefer documenting/using current schema fields from `CommunitySettingsSchema`, `CommunityMeritSettingsSchema`, `CommunityVotingSettingsSchema`, and `TappalkaSettingsSchema`.

---

## Settings Import/Export

**Status:** Not implemented as a dedicated product feature in current codebase.

If needed in future, treat this as planned work and define explicit API/storage format first.

---

## Global and Local Community Interaction

### Action Payment Rules
- Post/poll/forward costs come from `settings.postCost`, `settings.pollCost`, `settings.forwardCost`.
- Priority communities (МД, ОБ, Projects, Support, or `isPriority=true`) use global merit context.
- Local communities use local merit context for wallet/quota logic.
- Voting source restrictions are configured through `votingSettings.currencySource` and enforced by domain logic.

### Forwarding Between Communities

| From | To | Mode |
|------|-----|------|
| Global | Global | Configured by admin |
| Local | Any | ALWAYS copy without merits |
| "Projects" | "MД" | Transfer WITH merits (special MVP rule) |

---

## Implementation Notes

### Community Creation
```
1. Validate required fields
2. Set type (global/local)
3. Apply default settings
4. If local: assign creator as lead
5. If global: require superadmin permission
```

### Member Join Logic
```
Global community:
- Auto-join all users at registration
- No leave option

Local community:
- Join via invite or request
- Leave anytime
```

### Settings Validation
```
- `investorShareMin` and `investorShareMax` must be within 1..99 and `min <= max`
- `commentMode` must be one of `all | neutralOnly | weightedOnly`
- `votingRestriction` accepts `any | not-same-team` (legacy values normalized)
- Deprecated `tappalkaOnlyMode` maps to `commentMode='neutralOnly'` for backward compatibility
```

---

## Future Features (v2.0+)

### Community Wallet
Local community will be able to act as participant in global communities:
- Admin posts on behalf of community
- Community receives and spends merits
- Separate balance from members' personal wallets
