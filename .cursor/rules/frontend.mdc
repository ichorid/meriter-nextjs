---
description: React and Next.js patterns for frontend development. Include when working with web components, hooks, routes, and client data flows.
globs:
  - web/src/**/*
alwaysApply: false
---

# Frontend Patterns (React + Next.js)

## Tech Stack
- React 19 + Next.js 16 (App Router)
- TypeScript (strict)
- TanStack Query + tRPC client
- REST client via Axios (`lib/api/client.ts`, `lib/api/v1`)
- Tailwind CSS
- Zustand (state management)

## Web Structure (web/src)
- `app/` — App Router pages/layouts/routes
- `components/` — UI building blocks
- `features/` — feature-focused modules
- `hooks/` — reusable hooks (`hooks/api/*` for API-facing hooks)
- `stores/` — Zustand stores
- `contexts/` — React Context providers (auth/app mode)
- `providers/` — app-level providers (Query/tRPC)
- `shared/` — shared UI/helpers/state used across features
- `lib/` — client libraries and utilities
- `config/` — frontend runtime/static configuration
- `types/` — frontend types
- `i18n/` — i18n config/request setup
- `generated/` — generated artifacts (currently build info)
- `__tests__/` — tests

## Component Guidelines

### Component Structure
```typescript
// components/organisms/Publication/PublicationActions.tsx

'use client';

import { trpc } from '@/lib/trpc/client';
import { Button } from '@/components/ui/shadcn/button';

interface PublicationActionsProps {
  publicationId: string;
  communityId: string;
}

export function PublicationActions({ publicationId, communityId }: PublicationActionsProps) {
  const utils = trpc.useUtils();
  const voteMutation = trpc.votes.create.useMutation({
    onSuccess: async () => {
      await utils.publications.getById.invalidate({ id: publicationId });
      await utils.communities.getFeed.invalidate({ communityId });
    },
  });

  return (
    <div className="flex gap-2">
      <Button
        onClick={() =>
          voteMutation.mutate({
            targetType: 'publication',
            targetId: publicationId,
            quotaAmount: 1,
            walletAmount: 0,
            direction: 'up',
            communityId,
          })
        }
      >
        Vote
      </Button>
    </div>
  );
}
```

### Component Rules
- One component per file
- Props interface defined above component
- 'use client' only when necessary
- Destructure props in function signature
- Prefer named exports for new components (existing default exports may remain where already used)

## Data Fetching

### tRPC (Authenticated)
```typescript
// hooks/api/usePublications.ts
import { trpc } from '@/lib/trpc/client';

export function usePublications(communityId?: string) {
  return trpc.publications.getAll.useQuery(
    { communityId, pageSize: 20 },
    { enabled: !!communityId }
  );
}

export function useCreatePublication() {
  const utils = trpc.useUtils();

  return trpc.publications.create.useMutation({
    onSuccess: async () => {
      await utils.publications.getAll.invalidate();
    },
  });
}
```

### REST (Unauthenticated / specific endpoints)
```typescript
// hooks/api/useAuth.ts
import { useMutation } from '@tanstack/react-query';
import { authApiV1 } from '@/lib/api/v1';

export function useFakeAuth() {
  return useMutation({
    mutationFn: () => authApiV1.authenticateFakeUser(),
  });
}
```

## State Management

### Zustand Store Pattern
```typescript
// stores/ui.store.ts
import { create } from 'zustand';

interface UIState {
  activeModal: string | null;
  setActiveModal: (modal: string | null) => void;
}

export const useUIStore = create<UIState>((set) => ({
  activeModal: null,
  setActiveModal: (modal) => set({ activeModal: modal }),
}));
```

### When to Use What
| State Type | Solution |
|------------|----------|
| Server data | TanStack Query (tRPC first) |
| Global UI state | Zustand |
| Cross-tree app state | React Context (`contexts/*`) |
| Form state | Local state or project form primitives |
| Component state | `useState` / `useReducer` |
| URL state | App Router params/search params |

## Styling (Tailwind)

### Class Organization
```tsx
<div 
  className={cn(
    // Layout
    "flex flex-col items-center",
    // Spacing
    "p-4 gap-2",
    // Visual
    "bg-white rounded-lg shadow",
    // Interactive
    "hover:bg-gray-50 transition-colors",
    // Conditional
    isActive && "ring-2 ring-blue-500"
  )}
/>
```

### Use `cn()` Utility
```typescript
// lib/utils.ts
import { clsx, type ClassValue } from 'clsx';
import { twMerge } from 'tailwind-merge';

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
```

## App Router Patterns

### Page Structure
```typescript
// app/meriter/communities/[id]/page.tsx

interface CommunityPageProps {
  params: Promise<{ id: string }>;
}

export default async function CommunityPage({ params }: CommunityPageProps) {
  const { id } = await params;
  return <CommunityPageClient communityId={id} />;
}
```

### Route-level Loading & Error Files
- `loading.tsx` and `error.tsx` are optional App Router conventions.
- Use them when route-level loading/error boundaries are needed.
- Do not assume every route has these files.

## Custom Hooks Pattern
```typescript
// hooks/api/useVotes.ts
import { trpc } from '@/lib/trpc/client';

export function useVoteOnPublication() {
  const utils = trpc.useUtils();

  return trpc.votes.create.useMutation({
    onSuccess: async (_result, variables) => {
      if (variables.targetType === 'publication') {
        await utils.publications.getById.invalidate({ id: variables.targetId });
      }
      await utils.publications.getAll.invalidate();
      await utils.communities.getAll.invalidate();
    },
  });
}
```

## API Layer Conventions
- Use `trpc` client from `@/lib/trpc/client` for authenticated domain operations.
- Use REST wrappers from `@/lib/api/v1` for auth/config and other explicitly REST endpoints.
- Central REST transport lives in `@/lib/api/client`.

## Common Mistakes

❌ Using ad-hoc `fetch` in app code instead of project API clients
❌ Importing non-existing paths (e.g. `@/lib/trpc` or `@/components/ui/Button`)
❌ Mixing old router names (`publication`/`vote`) with current routers (`publications`/`votes`)
❌ Business logic in components (extract to hooks)
❌ Forgetting 'use client' for interactive components
❌ Mutating state directly in Zustand
