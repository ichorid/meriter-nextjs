---
description: Master index of Meriter business rules. ALWAYS read this first to understand project context.
globs:
  - "**/*.ts"
  - "**/*.tsx"
alwaysApply: true
---

# Meriter Business Rules — Master Index

> Start here. This document provides overview of all business logic rules.

---

## Platform Overview

**Meriter** — merit-based social platform where users earn and spend "merits" (internal currency) to promote their ideas and projects.

**Current Status:** MVP "Marathon of Good" — gamified platform for schoolchildren doing good deeds.

**Core Principle:** More merits earned = higher trust = easier to get community support.

---

## Quick Reference: Key Rules

### Merit System Fundamentals
- **Two account types:** Wallet (permanent) + Quota (daily, burns)
- **Usage priority:** Quota FIRST, then Wallet
- **Fee payment:** ALWAYS from GLOBAL merits
- **Starting merits:** From platform setting `welcomeMeritsGlobal` (default 0 in code; MVP often uses 100)

### Community Types
- **Global:** All users auto-joined, share ONE merit, cannot leave
- **Local:** User-created, own merit, can leave

### Content Rules
- **Post cost:** `settings.postCost` (default 1); from quota first when `settings.canPayPostFromQuota` is true, else wallet (global)
- **Poll cost:** `settings.pollCost` (default 1)
- **Forward cost:** `settings.forwardCost` (default 1)
- **Self-voting:** Wallet only (if enabled), NEVER quota
- **Negative rating:** Author can close post (manual); closed post archived (cannot re-publish). Automatic deduction from author wallet after 24h is **not implemented**.

### Tappalka
- **10 comparisons = 1 merit** to user
- **Show cost:** 0.1 merit per post (both posts pay)
- **Win reward:** 1 merit (emission)

### Investments
- **Community toggle:** `settings.investingEnabled`
- **Contract bounds:** `settings.investorShareMin` / `settings.investorShareMax` (1..99)
- **Comment/vote mode:** `settings.commentMode` (`all` / `neutralOnly` / `weightedOnly`)
- **Lifecycle controls:** `settings.requireTTLForInvestPosts`, `settings.maxTTL`, `settings.inactiveCloseDays`, `settings.distributeAllByContractOnClose`

---

## Business Rules File Structure

| File | Content | When to Use |
|------|---------|-------------|
| `business-glossary.mdc` | All terminology and concepts | Understanding any term |
| `business-merits.mdc` | Merit system, wallet, quota, fees | Working with balances |
| `business-communities.mdc` | Community types, all settings | Community features |
| `business-content.mdc` | Posts, polls, comments, voting | Content features |
| `business-tappalka.mdc` | Comparison mechanics | Tappalka features |
| `business-investing.mdc` | Investment contracts, pool, distribution | Investment features |
| `business-users.mdc` | Users, roles, permissions | Auth, permissions |
| `business-mvp.mdc` | MVP-specific settings | **ALWAYS** (auto-applied) |

---

## MVP Communities Quick Reference

| Community | Withdraw? (`settings.allowWithdraw`) | Self-vote? (`permissionRules`) | Tappalka? (`tappalkaSettings.enabled`) | Costs (`settings.*Cost`) | Investing (`settings.investingEnabled`) |
|-----------|--------------------------------------|-------------------------------|-------------------------------------|---------------------------|-----------------------------------|
| **ОБ** (Image of Future) | No | Yes | No | Standard | No |
| **МД** (Marathon of Good) | Yes | No | Yes | Standard | Yes (current v1) |
| **Projects** | No | Yes | Yes | Standard | No |
| **Feedback** | Yes | No | No | Free defaults possible | No |

---

## Critical Implementation Rules

### 1. Fee Always Global
```
ANY community (including local) →
  Fee paid in GLOBAL merits →
    Merits BURNED
```

### 2. Voting Source Priority
```
Upvote: Quota → Wallet
Downvote: Wallet ONLY
Self-vote: Wallet ONLY (quota forbidden)
```

### 3. Forwarding (source community rule)
```
Forward mode = source community `settings.forwardRule`:
- `standard` (default): copy without merits, original preserved.
- `project`: transfer with merits, original deleted.
Participant-initiated forward (`proposeForward`) only when source `typeTag === 'team'`.
Lead/superadmin direct `forward`: no forward fee charged in current code.
```

### 4. Transfer with merits
```
Transfer with merits happens when source community has `settings.forwardRule === 'project'` (e.g. Projects → МД). Code does not restrict this to a single route.
```

### 5. Negative Rating Handling
```
Rating can be negative. Author can close post (manual, closeReason: 'negative_rating').
Closed post → Archive (cannot re-publish).
Automatic deduction from author wallet after 24h is not implemented.
```

---

## Permission Quick Reference

| Action | Check |
|--------|-------|
| Publish | `permissionRules` allow action + `settings.postCost` payable (quota first if `settings.canPayPostFromQuota`, else wallet; global context) |
| Comment/Vote | `permissionRules` allow action + `votingSettings.currencySource` + `settings.commentMode` |
| Self-vote | `permissionRules.conditions.canVoteForOwnPosts` + wallet-only constraint |
| Withdraw | `settings.allowWithdraw` |
| Tappalka | `tappalkaSettings.enabled` + rating >= `tappalkaSettings.minRating` |

**Implementation notes (current code):** Post withdrawal = `publications.withdraw` (gated by `settings.allowWithdraw` where enforced). `wallets.withdraw` and `wallets.transfer` exist but return NOT_IMPLEMENTED. No dedicated `commentFee`/`commentCost`; vote amounts and direction rules apply.

---

## Before Implementing Any Feature

1. ✅ Read relevant business rules file
2. ✅ Check feature status (implemented/not)
3. ✅ Check dependencies
4. ✅ Check MVP scope
5. ✅ Follow existing code patterns
6. ✅ Consider all community settings
7. ✅ Handle all role permissions
8. ✅ Follow merit flow rules

---

## Related Documentation

| Document | Location | Content |
|----------|----------|---------|
| AI Development Context | `docs/AI_DEVELOPMENT_CONTEXT.md` | How to work with this project |
| Cursor Workflow | `docs/CURSOR-WORKFLOW.md` | Step-by-step workflow |
| PRD Template | `docs/templates/PRD-TEMPLATE.md` | For new features |
| Architecture | `ARCHITECTURE.md` | Technical architecture |
| Business Logic (full) | `BUSINESS_LOGIC_DOCUMENTATION.md` | Complete business logic |

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | January 2026 | Initial structured version |
| 1.1 | February 2026 | Module split, decision integration |
| 1.2 | February 2026 | Align index with code: welcomeMeritsGlobal, negative rating not auto-deducted, forwardRule, wallet API notes |
