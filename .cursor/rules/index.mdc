---
description: Master context file for Meriter project. Always include this for any code changes.
globs:
  - "**/*"
alwaysApply: true
---

# Meriter Project Context

## What is Meriter?
Merit-based social platform operating through web. Users earn and spend "merits" (internal currency) to participate in community activities: create publications, vote for content creators, comment, participate in polls, and invest merits into posts.

## Tech Stack
- **Frontend**: React 19 + Next.js 16 + TypeScript + TanStack Query + tRPC + Tailwind + Zustand
- **Backend**: NestJS + TypeScript + tRPC + REST API
- **Database**: MongoDB 8 + Mongoose
- **Infrastructure**: pnpm monorepo, Docker Compose, Caddy reverse proxy, AWS S3/MinIO

## Repository Structure
```
meriter-nextjs/
├── api/                          # Backend (NestJS)
│   └── apps/meriter/src/
│       ├── api-v1/               # REST endpoints (auth/config/uploads)
│       ├── common/               # Shared backend helpers, interfaces, schemas
│       ├── config/               # Runtime config and validation
│       ├── decorators/           # Nest decorators
│       ├── domain/               # Domain models, services, business logic
│       ├── i18n/                 # Localization resources
│       ├── migrations/           # Migration scripts
│       ├── telegram/             # Telegram content integration
│       ├── tg-bots/              # Telegram bot module/services
│       ├── trpc/                 # tRPC app router, context, routers
│       └── updates-conductors/   # Updates conductor subsystem
├── web/                          # Frontend (Next.js)
│   └── src/
│       ├── app/                  # Next.js app router
│       ├── components/           # UI components
│       ├── config/               # Frontend runtime configuration
│       ├── contexts/             # React contexts
│       ├── features/             # Feature modules
│       ├── generated/            # Generated artifacts (e.g., build info)
│       ├── hooks/                # Custom hooks
│       ├── i18n/                 # Localization resources
│       ├── lib/                  # API clients, tRPC client, utilities
│       ├── providers/            # App providers
│       ├── shared/               # Shared UI/hooks/utils
│       ├── stores/               # Zustand stores
│       ├── types/                # Frontend types
│       └── __tests__/            # Tests
├── libs/shared-types/            # Shared Zod schemas and contracts
├── docs/                         # Project documentation directory
└── ARCHITECTURE.md               # Architecture overview (root-level file)
```

## Core Concepts
- **Merit**: Unit of reputation/currency within a community or several communities
- **Community**: Group created by users or administrators
- **Publication**: Content that can receive votes
- **Quota**: Daily free merits for voting (refreshes daily)
- **Wallet**: Accumulated merits in a community

## Key Patterns

### API Calls
- **Primary API pattern**: TanStack Query + tRPC (authenticated and many public reads via `publicProcedure`)
- **REST usage (`api-v1`)**: targeted endpoints for auth flows, config bootstrap, and compatibility paths
- **File uploads**: TanStack Query + tRPC mutations (`uploads.*`), with REST upload module also present server-side

### Schema Location
- Shared schemas: `libs/shared-types/src/`
- Backend schemas and model definitions: primarily `api/apps/meriter/src/domain/models/**/*.schema.ts`, plus backend validation schemas in `api/apps/meriter/src/config/` and selective shared schemas in `api/apps/meriter/src/common/schemas/`

### Naming Conventions
- Routes: core CRUD names (`getById`, `getAll`, `create`, `update`, `delete`) plus domain-specific operations (`getFeed`, `withdraw`, `transfer`, `close`, `restore`, `permanentDelete`, `search`, `markAllAsRead`, etc.)
- Files: kebab-case for files, PascalCase for components
- Variables: camelCase

## Implemented Feature Surface
- **Authentication**: JWT/cookie auth, fake auth endpoints, OAuth-compatible REST auth paths, and passkey/WebAuthn support
- **Content lifecycle**: publication create/update/delete, forward proposal workflow (`proposeForward`/`forward`/`rejectForward`), post close/restore/permanent delete flows
- **Communities and teams**: community management, team creation, team join request workflows, role operations
- **Economy**: wallets, withdrawals, transfers, quota handling, voting/polls/comments, investments, tappalka mechanics
- **Platform modules**: about content module, platform settings module, notifications, categories, search, uploads

## Before Making Changes
1. Check existing patterns in similar files
2. Use shared schemas when shape is reused
3. Run `pnpm lint` before committing
4. Update both frontend AND backend when changing contracts

## Related Rules
- @business-index.mdc — Voting rules, permissions, merit flow
- @architecture.mdc — Detailed code structure
- @frontend.mdc — React/Next.js patterns
- @backend.mdc — NestJS/tRPC patterns