---
description: Tappalka (comparison mechanism) business logic. Apply when working with tappalka features.
globs:
  - "**/tappalka*.ts"
  - "**/comparison*.ts"
alwaysApply: false
---

# Tappalka Business Logic

> Complete rules for the post comparison mechanism and merit emission.

---

## Concept

Tappalka — main method of merit emission and earning for users.

**Core Mechanic:**
1. User is shown 2 random posts from community
2. They choose which one they like more
3. Chosen post receives merit (emission)
4. For a series of comparisons, user receives reward

---

## Comparison Process

```
┌─────────────────────────────────────────────────────────┐
│           User opens Tappalka                           │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│    System selects 2 random posts from community         │
│    (user's OWN posts are NOT shown)                     │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│         User chooses one of two                         │
└───────┬───────────────────────────────┬─────────────────┘
        │                               │
        ▼                               ▼
┌───────────────────┐         ┌───────────────────────────┐
│  Chosen post      │         │   Unchosen post           │
│  +1 merit         │         │   0 merits                │
│  (emission)       │         │   (but show fee still     │
└───────────────────┘         │    deducted)              │
                              └───────────────────────────┘
```

### User Reward
- For **10 successfully completed comparisons** = **1 merit** to wallet
- Merits credited as emission (not from other users)

---

## Tappalka Parameters

### `tappalkaSettings` (Admin-Configurable)

| Field | Default | Description |
|------|---------|-------------|
| `tappalkaSettings.enabled` | `false` | Enables tappalka for community |
| `tappalkaSettings.categories` | `[]` | Allowed category IDs (`[]` = all categories) |
| `tappalkaSettings.winReward` | `1` | Reward for winning post |
| `tappalkaSettings.userReward` | `1` | Reward to user per cycle |
| `tappalkaSettings.comparisonsRequired` | `10` | Comparisons needed for user reward |
| `tappalkaSettings.showCost` | `0.1` | Cost per post show |
| `tappalkaSettings.minRating` | `1` | Minimum rating when paying showCost from rating; not a global filter (posts with rating below this can participate if they pay from investmentPool or pool + rating above stopLoss) |
| `tappalkaSettings.onboardingText` | optional | Community-specific onboarding text |

### Show Cost
- Each post show in tappalka costs **0.1 merit**
- Deduction priority: **investmentPool → post rating → author wallet**
- Deducted from **BOTH** posts in pair (winner AND loser)

---

## Post Participation in Tappalka

### Participation Conditions
1. `tappalkaSettings.enabled = true`
2. Post is eligible to pay showCost (see Post Selection Algorithm): at least one of (investmentPool ≥ showCost), (metrics.score ≥ max(minRating, showCost)), or (investmentPool + max(0, metrics.score − stopLoss) ≥ showCost). Thus a post with rating below minRating can participate if it can pay from pool (or pool + rating above stopLoss).
3. Post rating ≥ author's stop-loss setting (post `stopLoss`) when paying from rating.
4. Post not closed (`status !== 'closed'`) and not deleted (`deleted !== true`, `deletedAt` null)

### Exit from Tappalka
Post stops being shown if:
- Rating drops below minimum threshold
- Rating drops below author's stop-loss
- No funds for show payment: `investmentPool` and post rating (down to `stopLoss`) exhausted, and either author wallet is not used for show cost (`noAuthorWalletSpend === true`) or author wallet is insufficient

### Stop-Loss
- Set by post owner
- Minimum rating/merit threshold for showing
- Protection from "draining" merits on shows of losing post

### IMPORTANT: Cannot Disable Tappalka Show
- Author **CANNOT** choose "don't show in tappalka"
- Ways to remove or effectively limit post in tappalka:
  1. Set high stop-loss
  2. Set `noAuthorWalletSpend = true` (post exits once pool and rating down to stop-loss are exhausted; author wallet is not charged for shows)
  3. Close post and withdraw all merits

---

## Filtering in Tappalka

### By Categories
Tappalka category filtering is backed by `tappalkaSettings.categories`:
- `[]` means no category restriction (all categories allowed)
- non-empty array means only posts in those category IDs are eligible
- user-side selection should be intersected with community-level `tappalkaSettings.categories`

### By Content Type (Planned)
- Current code does **not** filter by `postType`; any publication in the collection that meets other conditions can be selected (including polls if they have the required fields).
- Planned: base posts with base posts, projects with projects; polls excluded from tappalka.

---

## Enabling Tappalka

### For Which Communities
- By default **DISABLED**
- In MVP: enabled only for **"Marathon of Good"** and **"Projects"**
- Configured separately for each community

### Connection with Quota
**DECISION:** Quota in global communities is **DISABLED** immediately after tappalka appears.

Logic: tappalka becomes main emission source, quota no longer needed to ensure activity.

---

## Abuse Protection

### Own Posts Not Shown
- User NEVER sees their own posts in tappalka
- Excludes possibility of "boosting" own posts

### Show Cost
- Both posts pay for show, even loser
- Makes creating "junk" posts for participation unprofitable

### Minimum Rating
- New posts without merits don't get into tappalka immediately
- Need to first get support through comments

---

## Implementation Details (Current)

### Onboarding
- Progress record has `onboardingSeen`; community `tappalkaSettings.onboardingText` is optional. API: `markOnboardingSeen(communityId)` sets onboardingSeen for (userId, communityId). Frontend uses onboarding flow and progress.onboardingSeen.

### Notifications
- When show-cost deduction depletes investment pool and cost remains, author receives `investment_pool_depleted` notification.
- When post exits tappalka (noAuthorWalletSpend and insufficient pool/rating), author receives notification (post exited tappalka, no funds for shows).

---

## Tappalka Economics

### Emission Balance

**Per one comparison:**
- Expense: 0.2 merit (0.1 × 2 posts for show)
- Income: 1 merit to winner
- Net emission: 0.8 merit

**Per 10 comparisons:**
- Expense: 2 merits (shows)
- Income to posts: 10 merits (10 winners)
- Income to user: 1 merit
- Net emission: 9 merits

### Inflation Control
- Fee for posts and comments burns merits
- Negative comments burn merits
- Negative ratings deduct merits from wallets

---

## Implementation Rules

### Post Selection Algorithm
```
1. Get all posts where:
   - communityId = current community
   - tappalkaSettings.enabled = true (effective for community)
   - authorId != currentUser
   - deleted !== true, deletedAt null
   - status !== 'closed'
   - at least one of post's categories is in tappalkaSettings.categories (if categories non-empty; else no category filter). Implementation: post has categories: string[]; query uses categories: { $in: categories }.
   - eligible to pay showCost: (investmentPool >= showCost) OR (metrics.score >= max(minRating, showCost)) OR (investmentPool + max(0, metrics.score - stopLoss) >= showCost)
2. Random select 2 posts from result
3. Return pair to user (sessionId generated per pair; not validated on submit)
```
Note: There is no global filter on metrics.score >= minRating. A post with rating below minRating can be selected if it satisfies the showCost eligibility via pool alone or via pool + rating above stopLoss.

### Show Cost Deduction
```
For each post in pair:
1. Deduct from `investmentPool` (up to remaining cost)
2. If insufficient, deduct from post rating (metrics.score), not below post `stopLoss`
3. If still insufficient and post `noAuthorWalletSpend !== true`, deduct from author wallet (community resolved via merit resolver, e.g. global for priority communities)
4. If noAuthorWalletSpend or all sources insufficient, post is excluded from future selections; author may be notified when pool depleted or post exits tappalka
```

### Win Processing
```
1. Increment chosen post `metrics.score` by tappalkaSettings.winReward (emission); increment post `lifetimeCredits` by same amount; set post `lastEarnedAt` to now
2. Get or create TappalkaProgress for (userId, communityId); increment comparisonCount
3. If progress.comparisonCount >= tappalkaSettings.comparisonsRequired:
   - Credit tappalkaSettings.userReward to user wallet (emission); wallet community resolved via merit resolver (e.g. global wallet for priority communities)
   - Set progress.comparisonCount to 0; increment totalRewardsEarned
```

### Transaction Ordering (Current)
```
Operations in submitChoice are sequential; no single database transaction is used:
- Show cost deducted from winner, then from loser
- Win reward and lastEarnedAt updated on winner
- User progress updated; if cycle complete, user reward credited to wallet
- Next pair fetched
```

### SessionId
- `sessionId` is generated per pair in getPair and returned to client; it is **not** validated on submitChoice. Replay or reuse of sessionId is not enforced.

---

## Metrics to Track (Planned)

The following are not fully implemented in current code. Implemented: per-user progress has `comparisonCount`, `totalComparisons`, `totalRewardsEarned` (TappalkaProgress); on post close, `closingSummary.spentOnShows` is set from pool difference.

### Per Community (planned)
- Total comparisons per day
- Total emission per day
- Average post participation rate
- Stop-loss trigger frequency

### Per Post (planned)
- Show count, win count, win rate
- Merits earned from tappalka (lifetimeCredits includes them)
- Merits spent on shows (only pool portion in closingSummary.spentOnShows at close)

### Per User (partially implemented)
- Comparisons completed: `TappalkaProgress.comparisonCount`, `totalComparisons`, `totalRewardsEarned`
- Merits earned from tappalka participation: via totalRewardsEarned and wallet
- Tappalka session duration: not implemented
